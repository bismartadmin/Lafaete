SELECT b.c_agreement_id                                                                                                                                  N_CONTRATO,
       ifslaf.C_Recurrent_Agreement_API.Get_Agreement_Type(ifslaf.C_Recurrent_Agreement_Util_API.Get_Opportunity_No(b.C_AGREEMENT_ID), b.C_AGREEMENT_ID) TIPO_CONTRATO,
       g.wo_no                                                                                                                                           N_OS,
       ifslaf.work_order_api.Get_Reg_Date(g.wo_no)                                                                                                       DATA_CRIACAO_OS,
       ifslaf.work_order_api.Get_Mch_Code(g.wo_no)                                                                                                       SERIAL,
       ifslaf.EQUIPMENT_SERIAL_API.Get_Part_No(ifslaf.work_order_api.Get_Mch_Code_Contract(g.wo_no), ifslaf.work_order_api.Get_Mch_Code(g.wo_no))        ID_MATERIAL,
       IFSLAF.PART_CATALOG_API.Get_Description(part_no_ => ifslaf.EQUIPMENT_SERIAL_API.Get_Part_No(ifslaf.work_order_api.Get_Mch_Code_Contract(g.wo_no),
       ifslaf.work_order_api.Get_Mch_Code(g.wo_no)), language_code_ => 'bp')                                                                             DESC_MATERIAL,
       COALESCE(ifslaf.work_order_api.Get_Cust_Order_No(g.wo_no),ifslaf.ACTIVE_SEPARATE_API.Get_Cust_Order_No(g.wo_no))                                  ID_OV_ORIGEM,
       ifslaf.HISTORICAL_SEPARATE_API.Get_Cust_Order_Line_No(g.wo_no)                                                                                    ID_LINHA_OV_ORIGEM,
       ifslaf.HISTORICAL_SEPARATE_API.Get_Cust_Order_Rel_No(g.wo_no)                                                                                     ID_ENTREGA_OV_ORIGEM,
       ifslaf.WORK_TYPE_API.Get_Description((ifslaf.work_order_api.Get_Work_Type_Id(g.wo_no)))                                                           TIPO_OS,
       ifslaf.person_info_api.Get_Name(person_id_ => ifslaf.work_order_api.Get_Reported_By(g.wo_no))                                                     APONTADO_POR,
       A.service_invoice_id                                                                                                                              ID_VF,
       a.service_invoice_line                                                                                                                            ID_LINHA_VF,
       g.created_date                                                                                                                                    DATA_CRIACAO_VF,
       b.site                                                                                                                                            ID_SITE,
       IFSLAF.FA_OBJECT_API.Get_Code_H(g.company, ifslaf.work_order_api.Get_Mch_Code(g.wo_no))                                                           ID_CODE_H_APR_CUSTO,
       B.customer_no                                                                                                                                     ID_CLIENTE,
       ifslaf.CUSTOMER_INFO_API.Get_Name(b.CUSTOMER_NO)                                                                                                  DESC_CLIENTE,
       a.sales_part_no                                                                                                                                   ID_MATERIAL_AVARIA,
       a.sales_part_description                                                                                                                          DESC_MATERIAL_AVARIA,
       a.QTY_TO_INVOICE                                                                                                                                  QTDE,
       a.sales_price                                                                                                                                     VALOR_UNITARIO,
       a.QTY_TO_INVOICE * a.sales_price                                                                                                                  VALOR_TOTAL,
       b.state                                                                                                                                           STATUS_VF,
       b.C_APPROVAL_DATE                                                                                                                                 DATA_APROVACAO_VF,
       MAX(c.mb_id)                                                                                                                                      ULTIMO_BM,
       ifslaf.C_MEASUREMENT_BULLETIN_API.Get_State(MAX(c.mb_id))                                                                                         STATUS_BM,
             NVL(C.BLOCKED_BILLING, 'FALSE')                                                                                                             FATURAMENTO_BLOQUEADO,
       d.order_no                                                                                                                                        ID_OV,
       D.date_entered                                                                                                                                    DATA_CRIACAO_OV,
       d.state                                                                                                                                           STATUS_LINHA_OV,
       e.invoice_id                                                                                                                                      ID_TITULO,
       (SELECT j.invoice_no FROM ifslaf.CUSTOMER_ORDER_INV_HEAD j WHERE j.company = d.company AND j.invoice_id = e.invoice_id)                           N_TITULO,
       ifslaf.CUSTOMER_ORDER_INV_HEAD_API.Get_Invoice_Date(d.company, e.invoice_id)                                                                      DATA_TITULO,
       ifslaf.CUSTOMER_ORDER_INV_HEAD_API.Get_Invoice_Status(d.company, e.invoice_id)                                                                    STATUS_TITULO,
       (SELECT j.due_date FROM ifslaf.CUSTOMER_ORDER_INV_HEAD j WHERE j.company = d.company AND j.invoice_id = e.invoice_id)                             DATA_VENCIMENTO,  
       e.sale_unit_price * e.invoiced_qty                                                                                                                VALOR_FATURADO
  FROM IFSLAF.SERVICE_INVOICE_LINE_UIV A
 INNER JOIN IFSLAF.SERVICE_INVOICE_UIV B ON (A.SERVICE_INVOICE_ID = B.SERVICE_INVOICE_ID)
 left JOIN IFSLAF.JT_TASK_SALES_LINE_UIV G ON (A.SERVICE_INVOICE_ID = G.SERVICE_INVOICE_ID AND A.SERVICE_INVOICE_LINE = G.INVOICE_LINE_SEQ)
  LEFT JOIN IFSLAF.C_BULLETIN_FAILURE C ON (A.SERVICE_INVOICE_ID = C.SERVICE_INVOICE_ID AND A.SERVICE_INVOICE_LINE = C.INVOICE_LINE_SEQ)
  LEFT JOIN IFSLAF.CUSTOMER_ORDER_JOIN D ON (A.SERVICE_INVOICE_ID = D.DEMAND_ORDER_REF1 AND A.SERVICE_INVOICE_LINE = D.DEMAND_ORDER_REF2 AND D.ORDER_ID = 'AVA')
  LEFT JOIN IFSLAF.CUST_ORDER_INV_ITEM_UIV_ALL E ON (D.ORDER_NO = E.ORDER_NO AND D.LINE_NO = E.LINE_NO AND D.LINE_ITEM_NO = E.LINE_ITEM_NO)
 WHERE (IFSLAF.C_RECURRENT_AGREEMENT_API.GET_AGREEMENT_TYPE(IFSLAF.C_RECURRENT_AGREEMENT_UTIL_API.GET_OPPORTUNITY_NO(B.C_AGREEMENT_ID), B.C_AGREEMENT_ID) = 'Faturamento Direto')
   --AND (NVL(C.BLOCKED_BILLING_DB, 'FALSE') = 'FALSE')
 GROUP BY B.C_AGREEMENT_ID,
          A.SERVICE_INVOICE_ID,
          A.SERVICE_INVOICE_LINE,
                    G.WO_NO,
          G.CREATED_DATE,
          B.SITE,
          B.CUSTOMER_NO,
          A.SALES_PART_NO,
          A.SALES_PART_DESCRIPTION,
          A.QTY_TO_INVOICE,
          A.SALES_PRICE,
          G.COMPANY,
          B.STATE,
          B.C_APPROVAL_DATE,
          D.ORDER_NO,
          D.DATE_ENTERED,
          D.STATE,
          E.INVOICE_ID,
          D.COMPANY,
          E.SALE_UNIT_PRICE,
          E.INVOICED_QTY,
          c.blocked_billing

 UNION ALL

SELECT b.c_agreement_id AS "Contrato Recorrente",
       ifslaf.C_Recurrent_Agreement_API.Get_Agreement_Type(ifslaf.C_Recurrent_Agreement_Util_API.Get_Opportunity_No(b.C_AGREEMENT_ID), b.C_AGREEMENT_ID) AS "Tipo de Contrato",
       g.wo_no AS "N° OS",
       ifslaf.work_order_api.Get_Reg_Date(g.wo_no) AS "Data Criação OS",
       ifslaf.work_order_api.Get_Mch_Code(g.wo_no) AS "Serial",
       ifslaf.EQUIPMENT_SERIAL_API.Get_Part_No(ifslaf.work_order_api.Get_Mch_Code_Contract(g.wo_no), ifslaf.work_order_api.Get_Mch_Code(g.wo_no)) AS "Cod Material",
       IFSLAF.PART_CATALOG_API.Get_Description(part_no_ => ifslaf.EQUIPMENT_SERIAL_API.Get_Part_No(ifslaf.work_order_api.Get_Mch_Code_Contract(g.wo_no), ifslaf.work_order_api.Get_Mch_Code(g.wo_no)), language_code_ => 'bp') AS "Desc Material",
       COALESCE(ifslaf.work_order_api.Get_Cust_Order_No(g.wo_no),ifslaf.ACTIVE_SEPARATE_API.Get_Cust_Order_No(g.wo_no))                                     ID_OV_ORIGEM,
       ifslaf.HISTORICAL_SEPARATE_API.Get_Cust_Order_Line_No(g.wo_no)                                                                                    ID_LINHA_OV_ORIGEM,
       ifslaf.HISTORICAL_SEPARATE_API.Get_Cust_Order_Rel_No(g.wo_no)                                                                                     ID_ENTREGA_OV_ORIGEM,
       ifslaf.WORK_TYPE_API.Get_Description((ifslaf.work_order_api.Get_Work_Type_Id(g.wo_no))) AS "Tipo Manut",
       ifslaf.person_info_api.Get_Name(person_id_ => ifslaf.work_order_api.Get_Reported_By(g.wo_no)) AS "Apontado por",
       A.service_invoice_id AS "ID Visualização de Fatura",
       a.service_invoice_line AS "ID da Linha",
       g.created_date AS "Data Criação Avaria",
       b.site AS "Site",
       IFSLAF.FA_OBJECT_API.Get_Code_H(g.company, ifslaf.work_order_api.Get_Mch_Code(g.wo_no)) APR_CUSTO,
       B.customer_no AS "ID Cliente",
       ifslaf.CUSTOMER_INFO_API.Get_Name(b.CUSTOMER_NO) AS "Nome Cliente",
       a.sales_part_no AS "Cod avaria",
       a.sales_part_description AS "Descrição da Avaria",
       a.QTY_TO_INVOICE AS "Quantidade",
       a.sales_price AS "Valor unitario",
       a.QTY_TO_INVOICE * a.sales_price AS "Valor total",
       b.state AS "Status",
       b.C_APPROVAL_DATE AS "Data Aprovação",
       MAX(c.mb_id) AS "Último BM",
       ifslaf.C_MEASUREMENT_BULLETIN_API.Get_State(MAX(c.mb_id)) AS "Status BM",
       NVL(C.BLOCKED_BILLING, 'FALSE')                                         FATURAMENTO_BLOQUEADO,
       F.order_no AS "Ordem de Venda",
       IFSLAF.CUSTOMER_ORDER_LINE_API.Get_Date_Entered(F.ORDER_NO, F.LINE_NO, F.REL_NO, F.LINE_ITEM_NO) AS "Data Ordem",
       IFSLAF.CUSTOMER_ORDER_LINE_API.Get_State(F.ORDER_NO, F.LINE_NO, F.REL_NO, F.LINE_ITEM_NO) AS "Status",
       e.invoice_id ,
       (SELECT j.invoice_no FROM ifslaf.CUSTOMER_ORDER_INV_HEAD j WHERE j.company = e.company AND j.invoice_id = e.invoice_id)                           N_TITULO,
       ifslaf.CUSTOMER_ORDER_INV_HEAD_API.Get_Invoice_Date(E.company, e.invoice_id) ,
       ifslaf.CUSTOMER_ORDER_INV_HEAD_API.Get_Invoice_Status(E.company, e.invoice_id) ,
       (SELECT j.due_date FROM ifslaf.CUSTOMER_ORDER_INV_HEAD j WHERE j.company = e.company AND j.invoice_id = e.invoice_id)                             DATA_VENCIMENTO,
       e.sale_unit_price * e.invoiced_qty
  FROM IFSLAF.SERVICE_INVOICE_LINE_UIV A
 INNER JOIN IFSLAF.SERVICE_INVOICE_UIV B ON (A.SERVICE_INVOICE_ID = B.SERVICE_INVOICE_ID)
 INNER JOIN IFSLAF.JT_TASK_SALES_LINE_UIV G ON (A.SERVICE_INVOICE_ID = G.SERVICE_INVOICE_ID AND A.SERVICE_INVOICE_LINE = G.INVOICE_LINE_SEQ)
  LEFT JOIN IFSLAF.C_BULLETIN_FAILURE C ON (A.SERVICE_INVOICE_ID = C.SERVICE_INVOICE_ID AND A.SERVICE_INVOICE_LINE = C.INVOICE_LINE_SEQ)
  LEFT JOIN IFSLAF.C_BULLETIN_CUSTOMER_ORDER_TAB F ON (C.MB_ID = F.MB_ID AND F.BULLETIN_TAB = 'FAILURE' AND C.FAILURE_ID = F.ID)
  LEFT JOIN IFSLAF.CUST_ORDER_INV_ITEM_UIV_ALL E ON (F.ORDER_NO = E.ORDER_NO AND F.LINE_NO = E.LINE_NO AND F.REL_NO = E.RELEASE_NO)
 WHERE (IFSLAF.C_RECURRENT_AGREEMENT_API.GET_AGREEMENT_TYPE(IFSLAF.C_RECURRENT_AGREEMENT_UTIL_API.GET_OPPORTUNITY_NO(B.C_AGREEMENT_ID), B.C_AGREEMENT_ID) = 'Medição')
 --AND b.c_agreement_id = 1973
   AND (NVL(C.BLOCKED_BILLING_DB, 'FALSE') = 'FALSE') 
 GROUP BY B.C_AGREEMENT_ID,
          A.SERVICE_INVOICE_ID,
          A.SERVICE_INVOICE_LINE,
          G.WO_NO,
          G.CREATED_DATE,
          B.SITE,
          B.CUSTOMER_NO,
          A.SALES_PART_NO,
          A.SALES_PART_DESCRIPTION,
          A.QTY_TO_INVOICE,
          A.SALES_PRICE,
          B.STATE,
          G.COMPANY,
          B.C_APPROVAL_DATE,
          F.ORDER_NO,
          E.INVOICE_ID,
          E.COMPANY,
          E.SALE_UNIT_PRICE,
          E.INVOICED_QTY,
          F.LINE_NO,
          F.REL_NO,
          F.LINE_ITEM_NO,
          c.blocked_billing
          
 UNION ALL
 
 SELECT b.c_agreement_id AS "Contrato Recorrente",
       ifslaf.C_Recurrent_Agreement_API.Get_Agreement_Type(ifslaf.C_Recurrent_Agreement_Util_API.Get_Opportunity_No(b.C_AGREEMENT_ID), b.C_AGREEMENT_ID) AS "Tipo de Contrato",
       g.wo_no AS "N° OS",
       ifslaf.work_order_api.Get_Reg_Date(g.wo_no) AS "Data Criação OS",
       ifslaf.work_order_api.Get_Mch_Code(g.wo_no) AS "Serial",
       ifslaf.EQUIPMENT_SERIAL_API.Get_Part_No(ifslaf.work_order_api.Get_Mch_Code_Contract(g.wo_no), ifslaf.work_order_api.Get_Mch_Code(g.wo_no)) AS "Cod Material",
       IFSLAF.PART_CATALOG_API.Get_Description(part_no_ => ifslaf.EQUIPMENT_SERIAL_API.Get_Part_No(ifslaf.work_order_api.Get_Mch_Code_Contract(g.wo_no), ifslaf.work_order_api.Get_Mch_Code(g.wo_no)), language_code_ => 'bp') AS "Desc Material",
       COALESCE(ifslaf.work_order_api.Get_Cust_Order_No(g.wo_no),ifslaf.ACTIVE_SEPARATE_API.Get_Cust_Order_No(g.wo_no))                                     ID_OV_ORIGEM,
       ifslaf.HISTORICAL_SEPARATE_API.Get_Cust_Order_Line_No(g.wo_no)                                                                                    ID_LINHA_OV_ORIGEM,
       ifslaf.HISTORICAL_SEPARATE_API.Get_Cust_Order_Rel_No(g.wo_no)                                                                                     ID_ENTREGA_OV_ORIGEM,
       ifslaf.WORK_TYPE_API.Get_Description((ifslaf.work_order_api.Get_Work_Type_Id(g.wo_no))) AS "Tipo Manut",
       ifslaf.person_info_api.Get_Name(person_id_ => ifslaf.work_order_api.Get_Reported_By(g.wo_no)) AS "Apontado por",
       A.service_invoice_id AS "ID Visualização de Fatura",
       a.service_invoice_line AS "ID da Linha",
       g.created_date AS "Data Criação Avaria",
       b.site AS "Site",
       IFSLAF.FA_OBJECT_API.Get_Code_H(g.company, ifslaf.work_order_api.Get_Mch_Code(g.wo_no)) APR_CUSTO,
       B.customer_no AS "ID Cliente",
       ifslaf.CUSTOMER_INFO_API.Get_Name(b.CUSTOMER_NO) AS "Nome Cliente",
       a.sales_part_no AS "Cod avaria",
       a.sales_part_description AS "Descrição da Avaria",
       a.QTY_TO_INVOICE AS "Quantidade",
       a.sales_price AS "Valor unitario",
       a.QTY_TO_INVOICE * a.sales_price AS "Valor total",
       b.state AS "Status",
       b.C_APPROVAL_DATE AS "Data Aprovação",
       MAX(c.mb_id) AS "Último BM",
       ifslaf.C_MEASUREMENT_BULLETIN_API.Get_State(MAX(c.mb_id)) AS "Status BM",
       NVL(C.BLOCKED_BILLING, 'FALSE')                                         FATURAMENTO_BLOQUEADO,
       F.order_no AS "Ordem de Venda",
       IFSLAF.CUSTOMER_ORDER_LINE_API.Get_Date_Entered(F.ORDER_NO, F.LINE_NO, F.REL_NO, F.LINE_ITEM_NO) AS "Data Ordem",
       IFSLAF.CUSTOMER_ORDER_LINE_API.Get_State(F.ORDER_NO, F.LINE_NO, F.REL_NO, F.LINE_ITEM_NO) AS "Status",
       e.invoice_id ,
       (SELECT j.invoice_no FROM ifslaf.CUSTOMER_ORDER_INV_HEAD j WHERE j.company = e.company AND j.invoice_id = e.invoice_id)                           N_TITULO,
       ifslaf.CUSTOMER_ORDER_INV_HEAD_API.Get_Invoice_Date(E.company, e.invoice_id) ,
       ifslaf.CUSTOMER_ORDER_INV_HEAD_API.Get_Invoice_Status(E.company, e.invoice_id) ,
       (SELECT j.due_date FROM ifslaf.CUSTOMER_ORDER_INV_HEAD j WHERE j.company = e.company AND j.invoice_id = e.invoice_id)                             DATA_VENCIMENTO,
       e.sale_unit_price * e.invoiced_qty
  FROM IFSLAF.SERVICE_INVOICE_LINE_UIV A
 INNER JOIN IFSLAF.SERVICE_INVOICE_UIV B ON (A.SERVICE_INVOICE_ID = B.SERVICE_INVOICE_ID)
 INNER JOIN IFSLAF.JT_TASK_SALES_LINE_UIV G ON (A.SERVICE_INVOICE_ID = G.SERVICE_INVOICE_ID AND A.SERVICE_INVOICE_LINE = G.INVOICE_LINE_SEQ)
  LEFT JOIN IFSLAF.C_BULLETIN_FAILURE C ON (A.SERVICE_INVOICE_ID = C.SERVICE_INVOICE_ID AND A.SERVICE_INVOICE_LINE = C.INVOICE_LINE_SEQ)
  LEFT JOIN IFSLAF.C_BULLETIN_CUSTOMER_ORDER_TAB F ON (C.MB_ID = F.MB_ID AND F.BULLETIN_TAB = 'FAILURE' AND C.FAILURE_ID = F.ID)
  LEFT JOIN IFSLAF.CUST_ORDER_INV_ITEM_UIV_ALL E ON (F.ORDER_NO = E.ORDER_NO AND F.LINE_NO = E.LINE_NO AND F.REL_NO = E.RELEASE_NO)
       JOIN IFSLAF.C_REC_AGREEMENT_PENDENCIES X ON (X.agreement_id = B.c_agreement_id AND (X.agreement_id = B.c_agreement_id and concat(x.MB_ID_INITIAL, x.MB_LINE_ID_INITIAL) = concat(c.MB_ID, c.invoice_line_seq) ))
 WHERE (IFSLAF.C_RECURRENT_AGREEMENT_API.GET_AGREEMENT_TYPE(IFSLAF.C_RECURRENT_AGREEMENT_UTIL_API.GET_OPPORTUNITY_NO(B.C_AGREEMENT_ID), B.C_AGREEMENT_ID) = 'Medição')
-- AND b.c_agreement_id = 1973
   AND C.BLOCKED_BILLING_DB = 'TRUE'
   
 GROUP BY B.C_AGREEMENT_ID,
          A.SERVICE_INVOICE_ID,
          A.SERVICE_INVOICE_LINE,
          G.WO_NO,
          G.CREATED_DATE,
          B.SITE,
          B.CUSTOMER_NO,
          A.SALES_PART_NO,
          A.SALES_PART_DESCRIPTION,
          A.QTY_TO_INVOICE,
          A.SALES_PRICE,
          B.STATE,
          G.COMPANY,
          B.C_APPROVAL_DATE,
          F.ORDER_NO,
          E.INVOICE_ID,
          E.COMPANY,
          E.SALE_UNIT_PRICE,
          E.INVOICED_QTY,
          F.LINE_NO,
          F.REL_NO,
          F.LINE_ITEM_NO,
          c.blocked_billing
