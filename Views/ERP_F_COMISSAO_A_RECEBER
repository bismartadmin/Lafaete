SELECT A.COMPANY ID_EMPRESA,
               IFSLAF.COMPANY_API.Get_Name(A.company) DESC_EMPRESA,
               coalesce(A.CODE_c,ifslaf.MAN_CUST_INVOICE_API.Get_Code_C(company_ => a.COMPANY ,invoice_id_ => a.INVOICE_ID) , IFSLAF.CUSTOMER_ORDER_API.Get_Contract(IFSLAF.CUSTOMER_ORDER_INV_HEAD_API.GET_CREATORS_REFERENCE(A.COMPANY, A.INVOICE_ID))) ID_SITE,
               IFSLAF.COMPANY_SITE_API.Get_Description(coalesce(A.CODE_c,ifslaf.MAN_CUST_INVOICE_API.Get_Code_C(company_ => a.COMPANY ,invoice_id_ => a.INVOICE_ID) , IFSLAF.CUSTOMER_ORDER_API.Get_Contract(IFSLAF.CUSTOMER_ORDER_INV_HEAD_API.GET_CREATORS_REFERENCE(A.COMPANY, A.INVOICE_ID)))) DESC_SITE,
               A.IDENTITY ID_CLIENTE,
               coalesce(ifslaf.Customer_Hierarchy_API.Get_Description(ifslaf.Cust_Hierarchy_Struct_API.Get_Hierarchy_Id(A.IDENTITY)) , A.IDENTITY_NAME) DESC_CLIENTE,
               A.GROUP_ID GRUPO_CLIENTE,
               ifslaf.SALES_MARKET_API.Get_Description(ifslaf.CUST_ORD_CUSTOMER_API.Get_Market_Code(customer_no_ => a.IDENTITY)) DESC_MERCADO,
                              (SELECT C.fiscal_note_id FROM IFSLAF.FISCAL_NOTE C WHERE C.invoice_id = A.INVOICE_ID) ID_NF,
               (SELECT C.fiscal_note_no FROM IFSLAF.FISCAL_NOTE C WHERE C.invoice_id = A.INVOICE_ID) N_NF,
                A.INVOICE_NO N_TITULO,
               A.LEDGER_ITEM_ID ID_TITULO,
               A.VOUCHER_NO_REF NUM_LANCTO,
               A.INSTALLMENT_ID ID_PARCELA,
               A.INVOICE_SERIES ID_SERIE,
               A.LEDGER_DATE DATA_TITULO,
               A.DUE_DATE DATA_VENCIMENTO,
               A.C_DUE_DATE_ORG DATA_VENCIMENTO_ORIGINAL,
               IFSLAF.PAYMENT_PLAN_API.GET_C_LATE_DAYS_CUST(A.COMPANY, A.INVOICE_ID, A.INSTALLMENT_ID) DIAS_EM_ATRASO,
               A.OPEN_AMOUNT VALOR_EM_ABERTO,
               a.INV_AMOUNT VALOR_TOTAL_PARCELA,
               COALESCE((A.INV_AMOUNT - (select z.TAX_WITHHELD_CURR_AMOUNT from ifslaf.ABSTRACT_PAYMENT_PLAN2 Z where Z.invoice_id = A.INVOICE_ID and z.installment_id = a.INSTALLMENT_ID and z.party_type_db = 'CUSTOMER')),a.INV_AMOUNT) VALOR_LIQUID_PARCELA,
               A.CODE_H APR_CUSTO,
               IFSLAF.CUSTOMER_ORDER_INV_HEAD_API.GET_CREATORS_REFERENCE(A.COMPANY, A.INVOICE_ID) REFERENCIA,
               IFSLAF.CUSTOMER_ORDER_API.GET_C_OPPORTUNITY_NO(IFSLAF.CUSTOMER_ORDER_INV_HEAD_API.GET_CREATORS_REFERENCE(A.COMPANY, A.INVOICE_ID)) ID_OPORTUNIDADE,
               COALESCE(IFSLAF.CUSTOMER_ORDER_API.GET_C_AGREEMENT_ID(IFSLAF.CUSTOMER_ORDER_INV_HEAD_API.GET_CREATORS_REFERENCE(A.COMPANY, A.INVOICE_ID)), to_number(C.C2)) N_CONTRATO,
               IFSLAF.CUSTOMER_ORDER_API.Get_Quotation_No(IFSLAF.CUSTOMER_ORDER_INV_HEAD_API.GET_CREATORS_REFERENCE(A.COMPANY, A.INVOICE_ID)) N_COTACAO,
               IFSLAF.CUSTOMER_ORDER_API.Get_Salesman_Code(IFSLAF.CUSTOMER_ORDER_INV_HEAD_API.GET_CREATORS_REFERENCE(A.COMPANY, A.INVOICE_ID)) ID_REPRESENTANTE,
               IFSLAF.Sales_Part_Salesman_API.Get_Name(IFSLAF.CUSTOMER_ORDER_API.Get_Salesman_Code(IFSLAF.CUSTOMER_ORDER_INV_HEAD_API.GET_CREATORS_REFERENCE(A.COMPANY, A.INVOICE_ID))) DESC_REPRESENTANTE,
               COALESCE(IFSLAF.C_REC_AGREEMENT_INFO_API.GET_DIGITAL_AGREE_STATE(IFSLAF.CUSTOMER_ORDER_API.GET_C_OPPORTUNITY_NO(IFSLAF.CUSTOMER_ORDER_INV_HEAD_API.GET_CREATORS_REFERENCE(A.COMPANY, A.INVOICE_ID)),IFSLAF.CUSTOMER_ORDER_API.GET_C_AGREEMENT_ID(IFSLAF.CUSTOMER_ORDER_INV_HEAD_API.GET_CREATORS_REFERENCE(A.COMPANY, A.INVOICE_ID))),IFSLAF.CUSTOM_FIELD_ENUM_VALUES_API.Get_Client_Value('DOCUMENTSTATE',IFSLAF.ORDER_QUOTATION_CFP.Get_Cf$_Document_State(IFSLAF.ORDER_QUOTATION_API.Get_Objkey(IFSLAF.CUSTOMER_ORDER_API.Get_Quotation_No(IFSLAF.CUSTOMER_ORDER_INV_HEAD_API.GET_CREATORS_REFERENCE(A.COMPANY, A.INVOICE_ID)))))) STATUS_CONTRATO
               
               
          FROM IFSLAF.CUST_INV_INTEREST_FINE_QRY_cfv A left join ifslaf.MAN_CUST_INVOICE c on a.INVOICE_ID = c.INVOICE_ID
         WHERE   A.PARTY_TYPE_DB = 'CUSTOMER'
           AND A.ADV_INV = 'FALSE'
           AND A.CLIENT_INV_STATE <> 'Cancelado'
           and A.OPEN_AMOUNT > 0
           and IFSLAF.IDENTITY_INVOICE_INFO_API.GET_IDENTITY_TYPE(A.COMPANY, A.IDENTITY, IFSLAF.CUSTOMER_INFO_API.GET_PARTY_TYPE(A.IDENTITY)) = 'Externo'
