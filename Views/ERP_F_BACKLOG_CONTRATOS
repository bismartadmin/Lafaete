SELECT TABCONTR.OBJVERSION,
       TABCONTR.COMPANY ID_EMPRESA,
       IFSLAF.COMPANY_API.GET_NAME(TABCONTR.COMPANY) AS DESC_EMPRESA,
       TABCONTR.AGREEMENT_ID AS N_CONTRATO,
       IFSLAF.C_REC_AGREEMENT_INFO_API.GET_AGREEMENT_MODEL(TABCONTR.OPPORTUNITY_NO, TABCONTR.AGREEMENT_ID) AS MODELO_CONTRATO,
       TRUNC(TABCONTR.CREATE_DATE) AS DATA_INICIAL,
       TRUNC(TABCONTR.END_PLANNED_DATE) AS DATA_FINAL,
       TABCONTR.CUSTOMER_ID AS ID_CLIENTE,
       IFSLAF.CUSTOMER_INFO_API.GET_NAME(TABCONTR.CUSTOMER_ID) AS DESC_CLIENTE,
       TABCONTR.SALESMAN_CODE AS ID_REPRESENTANTE,
              CASE NVL(TABCONTR.COMPANY, ' ')
                    WHEN '01' THEN CASE IFSLAF.C_RECURRENT_AGREEMENT_API.get_agREEMENT_MODALITY(TABCONTR.OPPORTUNITY_NO, TABCONTR.AGREEMENT_ID) WHEN 'MÃ³dulos' THEN '07' ELSE '03' END
                    WHEN '12' THEN '05'
                    WHEN '14' THEN '04'
                    WHEN '28' THEN '05'
                    WHEN '40' THEN '09'
                    WHEN '41' THEN '08'
                    WHEN '44' THEN '08'
                    WHEN '45' THEN '02'
                    WHEN '48' THEN '08'
                    WHEN '05' THEN '07'
                    WHEN '49' THEN '11'
                    WHEN '54' THEN '08'
               END AS ID_CODE_I_NEGOCIO ,
       CASE WHEN TABCONTR.VALOR_CONTRATO - TABCONTR.VALOR_FATURADO > 0 THEN TABCONTR.VALOR_CONTRATO ELSE TABCONTR.VALOR_MENSAL + TABCONTR.VALOR_FATURADO END AS VALOR_CONTRATO,
       TABCONTR.VALOR_FATURADO,
       CASE WHEN TABCONTR.VALOR_CONTRATO - TABCONTR.VALOR_FATURADO > 0 THEN TABCONTR.VALOR_CONTRATO - TABCONTR.VALOR_FATURADO ELSE TABCONTR.VALOR_MENSAL END AS VALOR_A_FATURAR
  FROM (SELECT CON.OBJVERSION,
               CON.COMPANY,
               CON.OPPORTUNITY_NO,
               CON.AGREEMENT_ID,
               NVL(BLO.START_DATE, CON.CREATE_DATE) AS CREATE_DATE,
               CON.END_PLANNED_DATE,
               CON.CUSTOMER_ID,
               CON.SALESMAN_CODE,
               NVL(BLO.MONTH_VALUE, 0) AS VALOR_MENSAL,
               NVL(ITE.VALOR_CONTRATO, 0) AS VALOR_CONTRATO,
               NVL(FAT.VALOR_NOTA, 0) AS VALOR_FATURADO
          FROM IFSLAF.C_RECURRENT_AGREEMENT_CFV CON
         INNER JOIN IFSLAF.IDENTITY_INVOICE_INFO CLI ON (CON.COMPANY = CLI.COMPANY AND CON.CUSTOMER_ID = CLI.IDENTITY AND IFSLAF.CUSTOMER_INFO_API.GET_CUSTOMER_CATEGORY(CON.CUSTOMER_ID) = CLI.PARTY_TYPE)
         INNER JOIN (SELECT OPPORTUNITY_NO,
                            AGREEMENT_ID,
                            MIN(START_DATE) AS START_DATE,
                            SUM(MONTH_VALUE) AS MONTH_VALUE
                       FROM IFSLAF.C_REC_AGREEMENT_RENTED_ASSET
                      WHERE RENTED_ASSET = 'TRUE'
                      GROUP BY OPPORTUNITY_NO,
                               AGREEMENT_ID) BLO ON (CON.OPPORTUNITY_NO = BLO.OPPORTUNITY_NO AND CON.AGREEMENT_ID = BLO.AGREEMENT_ID)
         INNER JOIN (SELECT OPPORTUNITY_NO,
                            AGREEMENT_ID,
                            SUM(TOTAL_EXPECTED_VALUE) AS VALOR_CONTRATO
                       FROM IFSLAF.C_REC_AGREEMENT_ITEM
                      WHERE STATE = 'Ativo'
                      GROUP BY OPPORTUNITY_NO,
                               AGREEMENT_ID) ITE ON (CON.OPPORTUNITY_NO = ITE.OPPORTUNITY_NO AND CON.AGREEMENT_ID = ITE.AGREEMENT_ID)
          LEFT JOIN (SELECT SUBTAB.OPPORTUNITY_NO,
                            SUBTAB.AGREEMENT_ID,
                            SUM(SUBTAB.NOTE_TOTAL_VALUE) AS VALOR_NOTA
                       FROM (SELECT IFSLAF.CUSTOMER_ORDER_API.GET_C_OPPORTUNITY_NO(NFE.C_FIRST_ORDER_NO) AS OPPORTUNITY_NO,
                                    IFSLAF.CUSTOMER_ORDER_API.GET_C_AGREEMENT_ID(NFE.C_FIRST_ORDER_NO) AS AGREEMENT_ID,
                                    NFE.NOTE_TOTAL_VALUE
                               FROM IFSLAF.FISCAL_NOTE NFE
                              INNER JOIN IFSLAF.OPERATION_CFV OPE ON (NFE.OPERATION_ID = OPE.OPERATION_ID AND NVL(OPE.CF$_OMD_OMR_AFFECTS_DB, '0') = '1')
                              WHERE NFE.OBJSTATE <> 'Cancelled') SUBTAB
                      WHERE SUBTAB.OPPORTUNITY_NO IS NOT NULL
                        AND SUBTAB.AGREEMENT_ID IS NOT NULL
                      GROUP BY SUBTAB.OPPORTUNITY_NO,
                               SUBTAB.AGREEMENT_ID) FAT ON (CON.OPPORTUNITY_NO = FAT.OPPORTUNITY_NO AND CON.AGREEMENT_ID = FAT.AGREEMENT_ID)
         WHERE CON.STATE = 'Ativo'
           AND CLI.IDENTITY_TYPE_DB <> 'INTERN'
           AND NVL(CON.CF$_BLOCKED_INVOICED_DB, '02') = '02'
           AND NVL(ITE.VALOR_CONTRATO, 0) > 0

        UNION ALL

        SELECT CON.OBJVERSION,
               CON.COMPANY,
               CON.OPPORTUNITY_NO,
               CON.AGREEMENT_ID,
               CON.CREATE_DATE,
               CON.END_PLANNED_DATE,
               CON.CUSTOMER_ID,
               CON.SALESMAN_CODE,
               0 AS VALOR_MENSAL,
               NVL(ITE.VALOR_CONTRATO, 0) AS VALOR_CONTRATO,
               NVL(FAT.VALOR_NOTA, 0) AS VALOR_FATURADO
          FROM IFSLAF.C_RECURRENT_AGREEMENT_CFV CON
         INNER JOIN IFSLAF.IDENTITY_INVOICE_INFO CLI ON (CON.COMPANY = CLI.COMPANY AND CON.CUSTOMER_ID = CLI.IDENTITY AND IFSLAF.CUSTOMER_INFO_API.GET_CUSTOMER_CATEGORY(CON.CUSTOMER_ID) = CLI.PARTY_TYPE)
         INNER JOIN (SELECT OPPORTUNITY_NO,
                            AGREEMENT_ID,
                            SUM(TOTAL_EXPECTED_VALUE) AS VALOR_CONTRATO
                       FROM IFSLAF.C_REC_AGREEMENT_ITEM
                      WHERE STATE = 'Ativo'
                      GROUP BY OPPORTUNITY_NO,
                               AGREEMENT_ID) ITE ON (CON.OPPORTUNITY_NO = ITE.OPPORTUNITY_NO AND CON.AGREEMENT_ID = ITE.AGREEMENT_ID)
          LEFT JOIN (SELECT SUBTAB.OPPORTUNITY_NO,
                            SUBTAB.AGREEMENT_ID,
                            SUM(SUBTAB.NOTE_TOTAL_VALUE) AS VALOR_NOTA
                       FROM (SELECT IFSLAF.CUSTOMER_ORDER_API.GET_C_OPPORTUNITY_NO(NFE.C_FIRST_ORDER_NO) AS OPPORTUNITY_NO,
                                    IFSLAF.CUSTOMER_ORDER_API.GET_C_AGREEMENT_ID(NFE.C_FIRST_ORDER_NO) AS AGREEMENT_ID,
                                    NFE.NOTE_TOTAL_VALUE
                               FROM IFSLAF.FISCAL_NOTE NFE
                              INNER JOIN IFSLAF.OPERATION_CFV OPE ON (NFE.OPERATION_ID = OPE.OPERATION_ID AND NVL(OPE.CF$_OMD_OMR_AFFECTS_DB, '0') = '1')
                              WHERE NFE.OBJSTATE <> 'Cancelled') SUBTAB
                      WHERE SUBTAB.OPPORTUNITY_NO IS NOT NULL
                        AND SUBTAB.AGREEMENT_ID IS NOT NULL
                      GROUP BY SUBTAB.OPPORTUNITY_NO,
                              SUBTAB.AGREEMENT_ID) FAT ON (CON.OPPORTUNITY_NO = FAT.OPPORTUNITY_NO AND CON.AGREEMENT_ID = FAT.AGREEMENT_ID)
         WHERE CON.STATE = 'Ativo'
           AND CLI.IDENTITY_TYPE_DB <> 'INTERN'
           AND NVL(CON.CF$_BLOCKED_INVOICED_DB, '02') = '02'
           AND NVL(ITE.VALOR_CONTRATO, 0) > 0
           AND NOT EXISTS (SELECT 1
                             FROM IFSLAF.C_REC_AGREEMENT_RENTED_ASSET BLO
                            WHERE BLO.OPPORTUNITY_NO = CON.OPPORTUNITY_NO
                              AND BLO.AGREEMENT_ID = CON.AGREEMENT_ID)
       ) TABCONTR
 WHERE (TABCONTR.AGREEMENT_ID NOT IN (1766, 2177, 5535, 70845, 73025))
   AND (NOT (TABCONTR.CUSTOMER_ID = '33000167' AND TABCONTR.VALOR_FATURADO = 0))
