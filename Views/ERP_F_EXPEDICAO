SELECT 
    A.ORDER_NO AS ID_OV,
    A.LINE_NO AS ID_LINHA_OV,
    A.REL_NO AS ID_ENTREGA_OV,
    A.order_id AS TIPO_OV,
    IFSLAF.CUST_ORDER_TYPE_API.Get_description(A.order_id) AS DESC_OV,
    A.CONTRACT AS ID_SITE,
    COALESCE(IFSLAF.FA_OBJECT_API.Get_Code_H(company_ => A.COMPANY ,object_id_ => A.CF$_SERIAL_NO),IFSLAF.C_RECURRENT_AGREEMENT_cfp.Get_Cf$_Code_H(objkey_ => IFSLAF.C_RECURRENT_AGREEMENT_API.Get_Objkey(opportunity_no_ => A.C_OPPORTUNITY_NO ,agreement_id_ => A.C_AGREEMENT_ID)),A.CONTRACT) AS ID_CODE_H_APR_CUSTO,
    A.CUSTOMER_NO AS ID_CLIENTE,
    A.CUSTOMER_NAME AS DESC_CLIENTE,
    IFSLAF.IDENTITY_INVOICE_INFO_API.Get_Identity_Type(a.COMPANY, a.CUSTOMER_NO, IFSLAF.CUSTOMER_INFO_API.GET_PARTY_TYPE(A.customer_no)) AS TIPO_PARCEIRO,
    COALESCE(IFSLAF.CUSTOMER_ORDER_API.Get_Cust_Ref(A.ORDER_NO),IFSLAF.C_RECURRENT_AGREEMENT_API.Get_Main_Contact_Id(A.C_OPPORTUNITY_NO,A.C_AGREEMENT_ID)) AS ID_CONTATO_CLIENTE,
    A.SALESMAN_CODE AS ID_REPRESENTANTE,
    IFSLAF.Sales_Part_Salesman_API.Get_Name(A.SALESMAN_CODE) AS DESC_REPRESENTANTE,
    IFSLAF.CUSTOMER_INFO_ADDRESS_API.Get_City(A.CUSTOMER_NO, A.SHIP_ADDR_NO) AS CIDADE_ENTREGA,
    IFSLAF.CUSTOMER_INFO_ADDRESS_API.Get_State(A.CUSTOMER_NO, A.SHIP_ADDR_NO) AS UF_ENTREGA,
    IFSLAF.CUSTOMER_INFO_ADDRESS_API.Get_City(A.CUSTOMER_NO, A.SHIP_ADDR_NO) || '-' || IFSLAF.CUSTOMER_INFO_ADDRESS_API.Get_State(A.CUSTOMER_NO, A.SHIP_ADDR_NO) AS CIDADE_UF,
    A.CATALOG_NO AS ID_MATERIAL,
    A.CATALOG_DESC AS DESC_MATERIAL,
    A.CATALOG_NO || '-' || A.CONTRACT AS CHAVE_MATERIAL_SITE,
    A.CF$_SERIAL_NO AS SERIAL,
    A.BUY_QTY_DUE AS QTDE,
    A.STATE AS STATUS_LINHA,
    A.ORDER_STATE AS STATUS_OV,
    A.C_OPPORTUNITY_NO AS ID_OPORTUNIDADE,
    A.C_AGREEMENT_ID AS N_CONTRATO,
    A.C_AGREEMENT_LINE_NO AS N_LINHA_CONTRATO,
    IFSLAF.CUSTOMER_ORDER_API.Get_Quotation_No(A.order_no) AS N_COTACAO_VENDAS,
    CASE
        WHEN A.CF$_SERIAL_NO IS NULL THEN 'Equipamento NÃ£o Reservado'
        WHEN A.CF$_SERIAL_NO IS NOT NULL THEN A.STATE
        ELSE a.CF$_STATUS_EQUIPMENT 
    END AS STATUS_OPERACIONAL,
    A.DATE_ENTERED AS DATA_CRIACAO,
    A.WANTED_DELIVERY_DATE AS DATA_DESEJADA_COMERCIAL,
    A.CF$_PCP_DATE AS DATA_PCP,
    A.CF$_FIRST_DATE_PCP AS PRIMEIRA_DATA_PCP,
    A.CF$_RESCHEDULING_PCP_REASO AS MOT_REAGENDAMENTO_PCP,
    A.CF$_LOGISTICS_RESCHEDULING,
    COALESCE(A.CF$_LOGISTICS_RESCHEDULING, (SELECT CASE 
            WHEN TO_CHAR(NVL(CF$_FIRST_DATE_PCP, CF$_PCP_DATE), 'D') =  '5' THEN NEXT_DAY(NVL(CF$_FIRST_DATE_PCP, CF$_PCP_DATE), 'MON')
            WHEN TO_CHAR(NVL(CF$_FIRST_DATE_PCP, CF$_PCP_DATE), 'D') IN ('1', '6', '7') THEN NEXT_DAY(NVL(CF$_FIRST_DATE_PCP, CF$_PCP_DATE), 'TUE')
            ELSE NVL(CF$_FIRST_DATE_PCP, CF$_PCP_DATE) + 2 END
FROM IFSLAF.CUSTOMER_ORDER_LINE_CFV
WHERE ORDER_NO = A.ORDER_NO
AND LINE_NO = A.LINE_NO
AND REL_NO = A.REL_NO)) AS DATA_LOGISTICA,
    A.CF$_RESCHEDULING_REASON AS MOT_REAGENDAMENTO_LOG,
    a.REAL_SHIP_DATE AS DATA_ENTREGA_REAL,
    A.CF$_CUSTOMER_MOBILIZATION AS MOB_CLIENTE,
    a.CF$_WITHDRAW_CALENDAR AS RETIRAR_AGENDA,
    a.CF$_REASON_WITHDRAWAL AS MOT_RETIRAR_AGENDA,
    A.CF$_NEW_CONTRACTS_VALUE AS VALOR_MENSAL,
    TO_DATE(IFSLAF.CUSTOMER_ORDER_LINE_API.Get_Objversion(order_no_ => A.ORDER_NO,line_no_ => A.LINE_NO,rel_no_ => A.REL_NO,line_item_no_ => A.LINE_ITEM_NO),'YYYY/MM/DD HH24:MI:SS') AS ULT_ATUALIZACAO,
    nvl(b.cf$_nf_remessa,'NAO') AS NF_REMESSA,
    nvl(b.cf$_ficha_vistoria,'NAO') AS FICHA_VISTORIA,
    nvl(b.cf$_ordem_servico,'NAO') AS ORDEM_SERVICO 
FROM 
    IFSLAF.CUSTOMER_ORDER_JOIN_CFV A left JOIN IFSLAF.C_REC_AGREE_IT_PROD_LINE_CFV b on (A.ORDER_NO = b.ORDER_NO and  A.LINE_NO = b.ORDER_line_no and A.REL_NO = b.ORDER_rel_no)
WHERE 
    --A.CF$_SERIAL_NO IS NULL OR A.CF$_SERIAL_NO IS NOT NULL
    A.OBJSTATE != 'Cancelled'
    AND A.ORDER_ID IN ('OV', 'OR','SBT')
