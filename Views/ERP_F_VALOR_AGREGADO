SELECT TO_date('01/'||A.CF$_MES_db||'/'||A.CF$_ANO,'DD/MM/YYYY') DATA_REFERENCIA,
       A.CF$_PROJETO ID_PROJETO,
       B.contract ID_SITE,
       B.description DESC_SITE,
       A.CF$_VALOR VALOR,
       A.CF$_QUANTIDADE QTDE,
       C.CODE_B ID_CODE_B_CR,
       C.DESCRIPTION DESC_CODE_B_CR,
       D.PART_NO ID_MATERIAL,
       D.DESCRIPTION DESC_MATERIAL,
       F.cf$_Natureza_Id ID_CODE_D_NATUREZA_GRUPO_COMPRA,
       F.CF$_NATUREZA_DESCRIPTION DESC_CODE_D_NATUREZA_GRUPO_COMPRA,
       G.PART_PRODUCT_FAMILY ID_FAMILIA_PRODUTO,
       G.DESCRIPTION AS DESC_FAMILIA_PRODUTO,
       H.CF$_NATURE_ID AS ID_CODE_NATUREZA_FAMILIA_PRODUTO,
       H.H.CF$_NATURE_DESCRIPTION AS DESC_NATUREZA_FAMILIA_PRODUTO
FROM IFSLAF.LAF_ANALISE_RESULTADO_CLV A
OUTER APPLY (SELECT B.contract, B.description FROM IFSLAF.COMPANY_SITE B WHERE B.objkey = A.CF$_SITE_DB) B
OUTER APPLY (SELECT C.CODE_B, C.description FROM IFSLAF.CODE_B C WHERE C.objkey = A.CF$_CENTRO_DE_RESULTADO_DB) C
OUTER APPLY (SELECT D.part_no, D.description FROM IFSLAF.PART_CATALOG D WHERE D.objkey = A.CF$_MATERIAL_DB) D
OUTER APPLY (SELECT F.cf$_Natureza_Id, F.CF$_NATUREZA_DESCRIPTION FROM IFSLAF.LAF_ACCOUNTING_PARAMETERS_CLV F WHERE F.cf$_Group_Id = ifslaf.PURCHASE_PART_API.Get_Stat_Grp(b.contract,d.part_no) AND F.cf$_Company_Id = ifslaf.company_site_api.Get_Company(b.contract)) F
OUTER APPLY (SELECT G.PART_PRODUCT_FAMILY, IFSLAF.Inventory_Product_Family_API.Get_Description(PART_PRODUCT_FAMILY) DESCRIPTION FROM ifslaf.INVENTORY_PART G WHERE CONCAT(G.PART_NO, G.CONTRACT) = CONCAT(D.PART_NO, B.CONTRACT)) G
OUTER APPLY (SELECT H.CF$_NATURE_ID, H.CF$_NATURE_DESCRIPTION FROM ifslaf.LAF_PROD_FAMILY_PARAMETERS_CLV H WHERE G.PART_PRODUCT_FAMILY = H.CF$_FAMILY_ID AND IFSLAF.COMPANY_SITE_API.Get_COMPANY(G.CONTRACT) = H.CF$_COMPANY_ID) H
