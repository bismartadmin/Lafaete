SELECT CI.CUSTOMER_ID ID_CLIENTE,
       CI.NAME DESC_CLIENTE,
       coalesce(ifslaf.Customer_Hierarchy_API.Get_Description(ifslaf.Cust_Hierarchy_Struct_API.Get_Hierarchy_Id(ci.CUSTOMER_ID)) , CI.NAME) DESC_CLIENTE_PRINCIPAL,
       CI.CREATION_DATE DATA_CRIACAO,
       CI.CUSTOMER_CATEGORY CATEGORIA_CLIENTE,
       ifslaf.CORPORATE_FORM_API.Get_Corporate_Form_Desc(ci.COUNTRY_DB, ci.CORPORATE_FORM) ORIGEM_INTEGRACAO,
       CASE CI.CUSTOMER_CATEGORY
          WHEN 'Cliente Potencial' THEN 'Cliente Potencial'
          WHEN 'Cliente' THEN
         CASE WHEN TRUNC(MONTHS_BETWEEN(SYSDATE,NVL(OV.DATA_OV,TO_DATE('01/01/2010','DD/MM/YYYY')))) < 4 THEN 'Ativo'
             WHEN TRUNC(MONTHS_BETWEEN(SYSDATE,GREATEST(NVL(OV.DATA_OV,TO_DATE('01/01/2010','DD/MM/YYYY')),NVL(CT.DATA_CT,TO_DATE('01/01/2010','DD/MM/YYYY')),NVL(BA.DATA_BA,TO_DATE('01/01/2010','DD/MM/YYYY'))))) > 3 THEN 'Inativo'
             WHEN TRUNC(MONTHS_BETWEEN(SYSDATE,NVL(OV.DATA_OV,TO_DATE('01/01/2010','DD/MM/YYYY')))) > 3 AND TRUNC(MONTHS_BETWEEN(SYSDATE,GREATEST(NVL(CT.DATA_CT,TO_DATE('01/01/2010','DD/MM/YYYY')),NVL(BA.DATA_BA,TO_DATE('01/01/2010','DD/MM/YYYY'))))) < 4 THEN 'Inativo em Prospecção'
         END
       END STATUS_CLIENTE,
       coalesce(IFSLAF.IDENTITY_INVOICE_INFO_API.Get_Identity_Type('01', CI.CUSTOMER_ID, 'Cliente'),IFSLAF.IDENTITY_INVOICE_INFO_API.Get_Identity_Type('14', CI.CUSTOMER_ID, 'Cliente'),IFSLAF.IDENTITY_INVOICE_INFO_API.Get_Identity_Type('40', CI.CUSTOMER_ID, 'Cliente'),IFSLAF.IDENTITY_INVOICE_INFO_API.Get_Identity_Type('41', CI.CUSTOMER_ID, 'Cliente'),IFSLAF.IDENTITY_INVOICE_INFO_API.Get_Identity_Type('28', CI.CUSTOMER_ID, 'Cliente')) TIPO_PARCEIRO,
       IFSLAF.INVOICE_PARTY_TYPE_GROUP_API.Get_Description('01', 'Cliente', IFSLAF.IDENTITY_INVOICE_INFO_API.Get_Group_Id('01', CI.CUSTOMER_ID, 'Cliente')) GRUPO_CLIENTE,
       IFSLAF.Payment_Term_API.Get_Description('01', IFSLAF.IDENTITY_INVOICE_INFO_API.Get_Pay_Term_Id('01', CI.CUSTOMER_ID, 'Cliente')) DESC_FORMA_PAGTO,
       IFSLAF.Customer_Group_API.Get_Description(IFSLAF.CUST_ORD_CUSTOMER_API.Get_Cust_Grp(CI.CUSTOMER_ID)) DESC_GRUPO_ESTATISTICO,
       IFSLAF.SALES_MARKET_API.Get_Description(IFSLAF.CUST_ORD_CUSTOMER_API.Get_Market_Code(CI.CUSTOMER_ID)) DESC_MERCADO,
       IFSLAF.CRM_CUST_INFO_API.Get_Source_Id(customer_id) DESC_ORIGEM_ATENDIMENTO,
       TRUNC(OV.DATA_OV) DATA_ULT_CRIACAO_OV,
       TRUNC(CT.DATA_CT) DATA_ULT_PROPOSTA,
       TRUNC(BA.DATA_BA) DATA_ULT_ATIVIDADE,
       (SELECT sum(OMR.VALOR_BRUTO) FROM IFSINFO.LAF_EMS_OMR_OMD OMR LEFT JOIN IFSLAF.FISCAL_NOTE FN ON OMR.ID_NOTA_FISCAL = FN.fiscal_note_id WHERE OMR.TIPO_NOTA = 'Receita' and OMR.TIPO_PARCEIRO = 'Externo' AND FN.addressee_id = CI.customer_id)   VALOR_FATURADO
                                                                                   
  FROM IFSLAF.CUSTOMER_INFO CI
 OUTER APPLY (SELECT B.DATE_ENTERED DATA_OV
                FROM IFSLAF.CUSTOMER_ORDER B
               WHERE B.CUSTOMER_NO = CI.CUSTOMER_ID
               ORDER BY B.DATE_ENTERED DESC FETCH FIRST ROW ONLY) OV
 OUTER APPLY (SELECT SUBTAB.DATA_CT
                FROM (SELECT B.CUSTOMER_NO,
                             B.DATE_ENTERED DATA_CT
                        FROM IFSLAF.ORDER_QUOTATION B

                      UNION ALL

                      SELECT B.CUSTOMER_ID,
                             B.CREATE_DATE
                        FROM IFSLAF.C_RECURRENT_AGREEMENT B) SUBTAB
               WHERE SUBTAB.CUSTOMER_NO = CI.CUSTOMER_ID
                 AND SUBTAB.DATA_CT IS NOT NULL
               ORDER BY SUBTAB.DATA_CT DESC FETCH FIRST ROW ONLY) CT
 OUTER APPLY (SELECT B.DATE_ENTERED DATA_BA
                FROM IFSLAF.BUSINESS_ACTIVITY B
               WHERE B.CONNECTION_TYPE_DB = 'CUSTOMER'
                 AND B.CONNECTION_ID = CI.CUSTOMER_ID
               ORDER BY B.DATE_ENTERED DESC FETCH FIRST ROW ONLY) BA

UNION ALL

SELECT BL.LEAD_ID Id_cliente,
       BL.NAME Nome_cliente,
       BL.NAME Nome_cliente_Agr,
       BL.CREATION_DATE Dt_Criacao,
       'Lead de Negocios' Categoria,
       ifslaf.CORPORATE_FORM_API.Get_Corporate_Form_Desc(BL.COUNTRY_DB, BL.CORPORATE_FORM) ORIGEM_INTEGRACAO,
       'Lead' Status_Cliente,
       'Externo' Tipo_Cliente,
       'CLIENTE NACIONAL' Grupo_Cliente,
       'Á VISTA' Forma_pagamento,
       'PESSOA JURIDICA' Grupo_estatistico_Cliente,
       IFSLAF.SALES_MARKET_API.Get_Description(BL.MARKET_CODE) Mercado,
       BL.SOURCE_ID Origem_de_Atendimento,
       TRUNC(OV.DATA_OV) DATA_ORDEM_VENDA,
       TRUNC(CT.DATA_CT) DATA_CONTRATO_COTACAO,
       TRUNC(BA.DATA_BA) DATA_ATIVIDADE,
       NULL VALOR_FATURADO
  FROM IFSLAF.BUSINESS_LEAD BL
 OUTER APPLY (SELECT B.DATE_ENTERED DATA_OV
                FROM IFSLAF.CUSTOMER_ORDER B
               WHERE B.CUSTOMER_NO = BL.LEAD_ID
               ORDER BY B.DATE_ENTERED DESC FETCH FIRST ROW ONLY) OV
 OUTER APPLY (SELECT SUBTAB.DATA_CT
                FROM (SELECT B.CUSTOMER_NO,
                             B.DATE_ENTERED DATA_CT
                        FROM IFSLAF.ORDER_QUOTATION B

                      UNION ALL

                      SELECT B.CUSTOMER_ID,
                             B.CREATE_DATE
                        FROM IFSLAF.C_RECURRENT_AGREEMENT B) SUBTAB
               WHERE SUBTAB.CUSTOMER_NO = BL.LEAD_ID
                 AND SUBTAB.DATA_CT IS NOT NULL
               ORDER BY SUBTAB.DATA_CT DESC FETCH FIRST ROW ONLY) CT
 OUTER APPLY (SELECT B.DATE_ENTERED DATA_BA
                FROM IFSLAF.BUSINESS_ACTIVITY B
               WHERE B.CONNECTION_TYPE_DB = 'CUSTOMER'
                 AND B.CONNECTION_ID = BL.LEAD_ID
               ORDER BY B.DATE_ENTERED DESC FETCH FIRST ROW ONLY) BA
