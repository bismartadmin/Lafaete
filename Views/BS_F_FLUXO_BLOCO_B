SELECT A.COMPANY,
               A.PARENT_COMPANY,
               A.PAYMENT_ID,
               A.SERIES_ID,
               B.TRANS_ID,
               IFSLAF.PAYMENT_PER_CURRENCY_API.GET_SHORT_NAME(A.COMPANY, A.SERIES_ID, A.PAYMENT_ID, A.CURRENCY) SHORT_NAME,
               A.VOUCHER_NO,
               A.VOUCHER_DATE,
               A.PAY_DATE,
               A.VOUCHER_TYPE,
               A.PAYMENT_TYPE_CODE,
               B.LEDGER_ITEM_ID,
               B.INSTALLMENT_ID,
               IFSLAF.PAYMENT_PLAN_API.GET_C_INVOICE_TYPE_ID(B.COMPANY, B.LEDGER_ITEM_ID, B.INSTALLMENT_ID) TIPO_TITULO,
               NULL LEDGER_DATE,
               NULL C_DUE_DATE_ORG,
               NULL DUE_DATE,
               B.IDENTITY,
               B.NAME,
               IFSLAF.LEDGER_TRANSACTION_API.GET_PARTY_TYPE(B.COMPANY, A.SERIES_ID, A.PAYMENT_ID, B.TRANS_ID) ESPECIE_PARCEIRO,
               IFSLAF.IDENTITY_INVOICE_INFO_API.GET_IDENTITY_TYPE(B.COMPANY, B.IDENTITY, IFSLAF.LEDGER_TRANSACTION_API.GET_PARTY_TYPE(B.COMPANY, A.SERIES_ID, A.PAYMENT_ID, B.TRANS_ID)) TIPO_PARCEIRO,
               B.PAYER_IDENTITY,
               C.CODE_A,
               C.CODE_B,
               C.CODE_C,
               C.CODE_D,
               C.CODE_E,
               C.CODE_F,
               C.CODE_G,
               C.CODE_H,
               C.CODE_I,
               C.CODE_J,
               case when ROUND(NVL(DECODE(B.IS_NEW_LEDGER_ITEM, 'FALSE', B.PAID_AMOUNT - NVL(B.BOE_DISCOUNT_FEE, 0), B.PAID_AMOUNT), 0), 2) > 0 then ROUND(NVL(DECODE(B.IS_NEW_LEDGER_ITEM, 'FALSE', B.PAID_AMOUNT - NVL(B.BOE_DISCOUNT_FEE, 0), B.PAID_AMOUNT), 0), 2) else (ROUND(NVL(DECODE(B.IS_NEW_LEDGER_ITEM, 'FALSE', B.PAID_AMOUNT - NVL(B.BOE_DISCOUNT_FEE, 0), B.PAID_AMOUNT), 0), 2))*-1 end VALOR,
               case when ROUND(NVL(DECODE(B.IS_NEW_LEDGER_ITEM, 'FALSE', B.PAID_AMOUNT - NVL(B.BOE_DISCOUNT_FEE, 0), B.PAID_AMOUNT), 0), 2) > 0 then 'Entrada' else 'Saida' end TIPO_MOVIMENTO,
               A.OBJVERSION,
               C.POSTING_TYPE,
               c.text,
               'B' BLOCO_CODIGO, -- IDENTIFICA TODOS OS JUROS, MULTAS E DESCONTOS DE CLIENTES (CUPAY)
               CASE WHEN IFSLAF.INVOICE_LEDGER_ITEM_API.Get_Adv_Inv(b.company,b.identity,b.party_type,b.ledger_item_series_id,b.ledger_item_id,b.ledger_item_version) = 'Verdadeiro' THEN 'TRUE' ELSE 'FALSE' END ADV_INV,
               B.LEDGER_ITEM_SERIES_ID
          FROM IFSLAF.PAYMENT_PER_CURRENCY_CU_QRY A
         INNER JOIN IFSLAF.LEDGER_TRANSACTION_CU_QRY  B ON (A.COMPANY = B.COMPANY AND A.SERIES_ID = B.SERIES_ID AND A.PAYMENT_ID = B.PAYMENT_ID)
         INNER JOIN IFSLAF.PAY_ACCOUNTING_ROW_CU_QRY  C ON (B.COMPANY = C.COMPANY AND B.SERIES_ID = C.SERIES_ID AND B.PAYMENT_ID = C.PAYMENT_ID AND B.TRANS_ID = C.TRANS_ID)
         WHERE (A.SERIES_ID = 'CUPAY')
           AND (A.VOUCHER_TYPE IN ('B', 'N', 'U'))
           AND (B.LEDGER_ITEM_SERIES_ID IN ('CUPOA'))
           AND (B.PAYMENT_TYPE_CODE_DB IN ('CUSTOFF', 'CUSTPAY', 'CUSTSUPPOFF'))
           AND (B.ROLLEDBACK = 'FALSE')
           AND (C.POSTING_TYPE IN ('PP10','PP8'))
           AND IFSLAF.PAYMENT_PER_CURRENCY_API.GET_SHORT_NAME(A.COMPANY, A.SERIES_ID, A.PAYMENT_ID, A.CURRENCY) IS NOT NULL
           AND A.PAYMENT_TYPE_CODE <> 'Finalizar Estorno do Cliente'
           AND (EXISTS(SELECT 1
                         FROM IFSLAF.CASH_TRANSACTION_CU_QRY Z 
                        WHERE (Z.COMPANY = A.COMPANY)
                          AND (Z.SERIES_ID = A.SERIES_ID)
                          AND (Z.PAYMENT_ID = A.PAYMENT_ID)
                          AND (Z.VOUCHER_DATE = A.VOUCHER_DATE)))
           AND (NOT EXISTS(SELECT 1
                             FROM IFSLAF.CUST_INV_INTEREST_FINE_QRY D
                            WHERE (D.COMPANY = B.COMPANY)
                              AND (D.IDENTITY = B.IDENTITY)
                              AND (D.PARTY_TYPE_DB = B.PARTY_TYPE_DB)
                              AND (D.LEDGER_ITEM_ID = B.LEDGER_ITEM_ID)
                              AND (D.LEDGER_ITEM_SERIES_ID = B.LEDGER_ITEM_SERIES_ID)
                              AND (D.LEDGER_ITEM_VERSION = B.LEDGER_ITEM_VERSION)))
          AND (EXISTS(SELECT 1
                  FROM IFSLAF.CASH_TRANSACTION Z 
                  WHERE (A.COMPANY = Z.COMPANY)
                    AND (A.SERIES_ID = Z.SERIES_ID)
                    AND (A.PAYMENT_ID = Z.PAYMENT_ID)
                    AND (Z.ROLLEDBACK = 'FALSE')))
