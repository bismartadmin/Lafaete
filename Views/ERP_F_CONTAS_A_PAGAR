SELECT A.LEDGER_ITEM_ID N_TITULO,
       A.INSTALLMENT_ID ID_PARCELA,
       A.CLIENT_INV_STATE STATUS_TITULO,
       CASE A.FULLY_PAID WHEN 'TRUE' THEN 'Pago' ELSE CASE WHEN A.DUE_DATE < SYSDATE THEN 'Vencido' ELSE 'A vencer' END END STATUS_TITULO_AJUST,
       A.INVOICE_ID ID_TITULO,
       C.ORDER_NO ID_OC,
       TRUNC(IFSLAF.PURCHASE_ORDER_API.GET_DATE_ENTERED(C.ORDER_NO)) DATA_CRIACAO_OC,
       TRUNC((SELECT POA.DATE_APPROVED
               FROM IFSLAF.PURCHASE_ORDER_APPROVAL POA
              WHERE POA.ORDER_NO = C.ORDER_NO
                AND POA.SEQUENCE_NO = (SELECT MAX(POM.SEQUENCE_NO) FROM IFSLAF.PURCHASE_ORDER_APPROVAL POM WHERE POM.ORDER_NO = POA.ORDER_NO))) DATA_ULT_APROVACAO_OC,
       CAST(NULL AS DATE) DATA_FECHAMENTO_OC,
       A.VOUCHER_NO_REF N_LANCTO,
       A.LEDGER_ITEM_SERIES_ID SERIE,
       A.LEDGER_DATE DATA_TITULO,
       (SELECT C.DUE_DATE
          FROM IFSLAF.ABSTRACT_PAYMENT_PLAN2 C
         WHERE C.INVOICE_ID = A.INVOICE_ID
           AND C.INSTALLMENT_ID = A.INSTALLMENT_ID
           AND C.IDENTITY = A.IDENTITY) DATA_VENCIMENTO_ORIGINAL,
       A.DUE_DATE DATA_VENCIMENTO,
       A.COMPANY ID_EMPRESA,
       A.IDENTITY ID_FORNECEDOR,
       A.NAME DESC_FORNECEDOR,
       A.GROUP_ID GRUPO_FORNECEDOR,
       A.C_CNPJ CNPJ_CPF_PARCEIRO,
       IFSLAF.IDENTITY_INVOICE_INFO_API.GET_IDENTITY_TYPE(A.COMPANY, A.IDENTITY, 'Fornecedor') TIPO_PARCEIRO,
       A.INV_AMOUNT VALOR_PARCELA,
       C.PERCENTUAL PERCENTUAL,
       A.INV_AMOUNT * NVL(C.PERCENTUAL, 1) VALOR_PARCELA_AJUSTADO,
       NVL(B.USED_DISCOUNT, 0) * NVL(C.PERCENTUAL, 1) DESCONTO_USADO,
       NVL(NVL(B.WITHHELD_TAX_CURR_AMOUNT,0)-NVL(B.WITHHELD_REDUCT_CURR_AMOUNT,0), 0) * NVL(C.PERCENTUAL, 1) IMPOSTOS_RETIDOS,
       NVL(B.PAID_AMOUNT, 0) * NVL(C.PERCENTUAL, 1) VALOR_PAGO,
       NVL(B.INTEREST_CURR_AMOUNT, 0) * NVL(C.PERCENTUAL, 1) VALOR_JUROS,
       NVL(B.FINE_CURR_AMOUNT, 0) * NVL(C.PERCENTUAL, 1) VALOR_MULTA,
       (NVL(B.PAID_AMOUNT, 0) + NVL(B.INTEREST_CURR_AMOUNT, 0) + NVL(B.FINE_CURR_AMOUNT, 0)) * NVL(C.PERCENTUAL, 1) VALOR_PAGO_TOTAL,
       A.OPEN_AMOUNT * NVL(C.PERCENTUAL, 1) VALOR_EM_ABERTO,
       B.PAYMENT_TYPE_CODE TIPO_PAGAMENTO,
       B.PAY_DATE DATA_PAGAMENTO,
       B.VOUCHER_DATE DATA_BAIXA,
       B.VOUCHER_PERIOD PERIODO_BAIXA,
       B.PAYMENT_ID CODIGO_BAIXA,
       NVL(C.CODE_B, A.CODE_B) ID_CODE_B_CR,
       NVL(C.CODE_C, A.CODE_C) ID_CODE_C_SITE,
       NVL(C.CODE_D, A.CODE_D) ID_CODE_D_NATUREZA,
       NVL(C.CODE_E, A.CODE_E) ID_CODE_E_ATIVO,
       NVL(C.CODE_F, A.CODE_F) ID_CODE_F_PROJETO,
       NVL(C.CODE_G, A.CODE_G) ID_CODE_G_LINHA,
       COALESCE(C.CODE_H, C.CODE_C, A.CODE_H, A.CODE_C) ID_CODE_H_APR_CUSTO,
       NVL(C.CODE_I, A.CODE_I) ID_CODE_I_NEGOCIO,
       UPPER(NVL(IFSLAF.PURCHASE_ORDER_APPROVAL_CFP.GET_CF$_FORMA_DE_PAGAMENTO(A.PO_REF_NUMBER), IFSLAF.FORMA_PAG_CFP.DECODE(IFSLAF.MAN_SUPP_INVOICE_CFP.GET_CF$_FORM_OF_PAYMENT(IFSLAF.MAN_SUPP_INVOICE_API.GET_OBJKEY(A.COMPANY, A.INVOICE_ID))))) FORMA_PAGTO,
       C.WAY_ID METODO_PGTO,
       coalesce(IFSLAF.PAYMENT_PER_CURRENCY_API.GET_SHORT_NAME(B.COMPANY, B.SERIES_ID, B.PAYMENT_ID, B.CURRENCY), (SELECT J.short_name FROM ifslaf.CASH_ACCOUNT J WHERE J.short_name = IFSLAF.PAYMENT_WAY_CFP.Get_Cf$_Cash_Account_Pay(IFSLAF.PAYMENT_WAY_API.Get_Objkey(A.COMPANY, c.way_id))), N.short_name) ID_CONTA_MOV,
       CASE TO_NUMBER(NVL(IFSLAF.ABSTRACT_PAYMENT_PLAN_CFP.GET_CF$_SANITIZE(A.OBJKEY), 1)) WHEN 0 THEN 'SIM' ELSE 'NAO' END SANEAMENTO,
       IFSLAF.CUSTOM_FIELD_ENUM_VALUES_API.Get_Client_Value('LafReasonSanitation', ifslaf.ABSTRACT_PAYMENT_PLAN_cfp.Get_Cf$_Sanitation_Reason(a.OBJKEY)) MOTIVO_SANEAMENTO,
       ifslaf.ABSTRACT_PAYMENT_PLAN_cfp.Get_Cf$_Sanitation_Date(a.OBJKEY) DATA_SANEAMENTO,
       ifslaf.ABSTRACT_PAYMENT_PLAN_cfp.Get_Cf$_User_Sanitation(a.OBJKEY) USUARIO_SANEAMENTO,
       (SELECT D.CF$_NOTAS_PARCELA
          FROM IFSLAF.ABSTRACT_PAYMENT_PLAN2_CFV D
         WHERE D.COMPANY = A.COMPANY
           AND D.INVOICE_ID = A.INVOICE_ID
           AND D.INSTALLMENT_ID = A.INSTALLMENT_ID) NOTAS_PARCELA,
       C.ID_NF ID_NOTA_FISCAL,
       C.NUMERO_NF N_NOTA_FISCAL,
       C.DATA_EMISSAO_NF DATA_EMISSAO_NF
  FROM IFSLAF.SUPP_INV_INTEREST_FINE_QRY A
  LEFT JOIN IFSLAF.LEDGER_TRANSACTION_SU_QRY B ON (A.COMPANY = B.COMPANY AND A.IDENTITY = B.IDENTITY AND A.PARTY_TYPE_DB = B.PARTY_TYPE_DB AND A.LEDGER_ITEM_ID = B.LEDGER_ITEM_ID AND A.LEDGER_ITEM_SERIES_ID = B.LEDGER_ITEM_SERIES_ID AND A.LEDGER_ITEM_VERSION = B.LEDGER_ITEM_VERSION AND A.INSTALLMENT_ID = B.INSTALLMENT_ID AND B.PAYMENT_TYPE_CODE_DB NOT IN ('COMPSUPPROLLBACK', 'TAXWITHHOLD') AND B.ROLLEDBACK = 'FALSE')
  LEFT JOIN IFSINFO.LAF_CODE_PART_TITULO C ON (A.COMPANY = C.COMPANY AND A.INVOICE_ID = C.INVOICE_ID)
  LEFT JOIN IFSLAF.PAYMENT_WAY_PER_IDENTITY C ON (C.COMPANY = A.COMPANY AND C.IDENTITY = A.IDENTITY AND C.DEFAULT_PAYMENT_WAY = 'TRUE')
 OUTER APPLY (SELECT N.SHORT_NAME
                FROM IFSLAF.CASH_ACCOUNT_CUSTOMER N
               WHERE N.COMPANY = A.COMPANY
                 AND N.DEFAULT_FLAG = 'TRUE') N
 WHERE (A.INV_AMOUNT <> 0)
   AND (A.CLIENT_INV_STATE <> 'Cancelado')
