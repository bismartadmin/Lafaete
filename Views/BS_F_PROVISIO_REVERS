WITH PROV_REVERS AS (
    SELECT 
        CF$_ADDITIONAL_COST_AMOUNT   AS CUSTO_ADICIONAL,
        CF$_ADDITIONAL_COST_INCL_T AS CUSTO_BRUTO_ADICIONAL_MOEDA,
        CF$_BUYER_CODE               AS ID_COMPRADOR,
        CF$_BUY_UNIT_MEAS            AS UM_COMPRA,
        CF$_BUY_UNIT_PRICE           AS PREÇO_BASE,
        CF$_BUY_UNIT_PRICE_INCL_TA  AS PREÇO_INCL_IMPOSTO_BASE,
        CF$_CODE_A                   AS CODE_A_CONTA,
        CF$_CODE_B                   AS CODE_B_CR,
        CF$_CODE_C                   AS CODE_C_SITE,
        CF$_CODE_D                   AS CODE_D_NATUREZA,
        CF$_CODE_E                   AS CODE_E_ATIVO_FIXO,
        CF$_CODE_F                   AS CODE_F_PROJETO,
        CF$_CODE_G                   AS CODE_G_LINHA,
        CF$_CODE_H                   AS CODE_H_APR_CUSTO,
        CF$_CODE_I                   AS CODE_I_NEGOCIO,
        CF$_COMPANY                  AS EMPRESA,
        CF$_CONTRACT                 AS SITE,
        CF$_CONTRACT_STATE           AS STATUS_DO_CONTRATO,
        CF$_DATA                     AS DATA,
        CF$_DATE_ENTERED             AS DATA_RECEBIMENTO_PLANEJADO,
        CF$_DESCRIPTION              AS DESCRIÇÃO,
        CF$_DISCOUNT                 AS DESCONTO,
        CF$_INVOICING_SUPPLIER       AS TÍTULO_DE_FORNECEDOR,
        CF$_LAST_SUPP_BUY            AS ÚLTIMO_FORNECEDOR,
        CF$_LINE_NO                  AS N_LINHA,
        CF$_NOTE_ID                  AS ID_NOTA,
        CF$_NOTE_TEXT                AS NOTAS,
        CF$_ORDER_NO                 AS N_ORDEM,
        CF$_ORIGINAL_QTY             AS QUANTIDADE_ANTERIOR,
        CF$_PART_NO                  AS CODIGO_PRODUTO,   
        ROW_NUMBER() OVER (PARTITION BY CF$_NOTE_ID, CASE WHEN CF$_BUY_UNIT_PRICE > 0 THEN 'Reversao' ELSE 'Provisionamento' END 
                              ORDER BY CF$_BUY_UNIT_PRICE DESC) AS ORDENACAO,
        CASE WHEN CF$_BUY_UNIT_PRICE > 0 THEN 'Reversao' ELSE 'Provisionamento' END AS TIPO_LANC
    FROM IFSLAF.LAF_GEST_MED_FIRST_CLV
)
SELECT  PROV_REVERS.CUSTO_ADICIONAL,
        PROV_REVERS.CUSTO_BRUTO_ADICIONAL_MOEDA,
        PROV_REVERS.ID_COMPRADOR,
        PROV_REVERS.UM_COMPRA,
        PROV_REVERS.PREÇO_BASE,
        PROV_REVERS.PREÇO_INCL_IMPOSTO_BASE,
        PROV_REVERS.CODE_A_CONTA,
        PROV_REVERS.CODE_B_CR,
        PROV_REVERS.CODE_C_SITE,
        PROV_REVERS.CODE_D_NATUREZA,
        PROV_REVERS.CODE_E_ATIVO_FIXO,
        PROV_REVERS.CODE_F_PROJETO,
        PROV_REVERS.CODE_G_LINHA,
        PROV_REVERS.CODE_H_APR_CUSTO,
        PROV_REVERS.CODE_I_NEGOCIO,
        PROV_REVERS.EMPRESA,
        PROV_REVERS.SITE,
        PROV_REVERS.STATUS_DO_CONTRATO,
        PROV_REVERS.DATA,
        PROV_REVERS.DATA_RECEBIMENTO_PLANEJADO,
        PROV_REVERS.DESCRIÇÃO,
        PROV_REVERS.DESCONTO,
        PROV_REVERS.TÍTULO_DE_FORNECEDOR,
        PROV_REVERS.ÚLTIMO_FORNECEDOR,
        PROV_REVERS.N_LINHA,
        PROV_REVERS.ID_NOTA,
        PROV_REVERS.NOTAS,
        PROV_REVERS.N_ORDEM,
        PROV_REVERS.QUANTIDADE_ANTERIOR,
        PROV_REVERS.CODIGO_PRODUTO  
FROM PROV_REVERS
ORDER BY ID_NOTA, ORDENACAO, TIPO_LANC
