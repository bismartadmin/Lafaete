WITH LAF_SUBTAB AS (
     SELECT A.ORDER_NO,
            CAST(B.C_AGREEMENT_ID AS VARCHAR2(12)) AS AGREEMENT_ID,
            B.QUOTATION_NO,
            C.SERIAL_NO,
            A.CF$_PCP_DATE,
            A.CF$_QTDE_REAGENDAMENTO_LOG
       FROM IFSLAF.CUSTOMER_ORDER_JOIN_CFV A
      INNER JOIN IFSLAF.CUSTOMER_ORDER B ON (A.ORDER_NO = B.ORDER_NO)
      INNER JOIN (SELECT ORDER_NO,
                         LINE_NO,
                         REL_NO,
                         SERIAL_NO
                    FROM IFSLAF.CUSTOMER_ORDER_RESERVATION
                   WHERE QTY_ASSIGNED > 0
                      OR QTY_PICKED > 0
                      OR QTY_SHIPPED > 0) C ON (A.ORDER_NO = C.ORDER_NO AND A.LINE_NO = C.LINE_NO AND A.REL_NO = C.REL_NO)
                      WHERE a.ORDER_ID IN ('OV','OR') --AND A.ORDER_NO IN ('31014','34462') AND C.SERIAL_NO = '21471'
       )

SELECT F.QUOTATION_NO                                                      AS N_COTACAO_VENDAS,
       F.C_AGREEMENT_ID                                                    AS N_CONTRATO,
       A.CUST_ORDER_NO                                                     AS ID_OV,
       COALESCE(B.CUST_ORDER_LINE_NO, C.CUST_ORDER_LINE_NO)                AS ID_LINHA_OV,
       COALESCE(B.CUST_ORDER_REL_NO, C.CUST_ORDER_REL_NO)                  AS ID_ENTREGA_OV,
       ifslaf.customer_order_line_cfp.Get_Cf$_Service_Billed(ifslaf.customer_order_line_api.Get_Objkey(A.cust_order_no ,COALESCE(B.CUST_ORDER_LINE_NO,C.CUST_ORDER_LINE_NO),COALESCE(B.cust_order_rel_no,C.cust_order_rel_no),COALESCE(B.cust_order_line_item_no,C.cust_order_line_item_no))) VALOR_FATURADO,
       F.CUSTOMER_NO                                                       AS ID_CLIENTE,
       IFSLAF.CUST_ORD_CUSTOMER_API.GET_NAME(F.CUSTOMER_NO)                AS DESC_CLIENTE,
       COALESCE(IFSLAF.CUSTOMER_ORDER_LINE_API.GET_CATALOG_NO(A.CUST_ORDER_NO, B.CUST_ORDER_LINE_NO, B.CUST_ORDER_REL_NO, B.CUST_ORDER_LINE_ITEM_NO), IFSLAF.CUSTOMER_ORDER_LINE_API.GET_CATALOG_NO(A.CUST_ORDER_NO, C.CUST_ORDER_LINE_NO, C.CUST_ORDER_REL_NO, C.CUST_ORDER_LINE_ITEM_NO)) AS ID_MATERIAL,
       COALESCE(IFSLAF.CUSTOMER_ORDER_LINE_API.GET_CATALOG_DESC(A.CUST_ORDER_NO, B.CUST_ORDER_LINE_NO, B.CUST_ORDER_REL_NO, B.CUST_ORDER_LINE_ITEM_NO), IFSLAF.CUSTOMER_ORDER_LINE_API.GET_CATALOG_DESC(A.CUST_ORDER_NO, C.CUST_ORDER_LINE_NO, C.CUST_ORDER_REL_NO, C.CUST_ORDER_LINE_ITEM_NO)) DESC_MATERIAL,
       COALESCE(IFSLAF.CUSTOMER_ORDER_LINE_API.GET_STATE(A.CUST_ORDER_NO, B.CUST_ORDER_LINE_NO, B.CUST_ORDER_REL_NO, B.CUST_ORDER_LINE_ITEM_NO), IFSLAF.CUSTOMER_ORDER_LINE_API.GET_STATE(A.CUST_ORDER_NO, C.CUST_ORDER_LINE_NO, C.CUST_ORDER_REL_NO, C.CUST_ORDER_LINE_ITEM_NO)) STATUS_LINHA_OV,
       A.WO_NO                                                             AS N_OS,
       A.ERR_DESCR                                                         AS DESC_OS,
       IFSLAF.ORGANIZATION_API.GET_DESCRIPTION(A.CONTRACT, A.ORG_CODE)     AS DESC_ORGANIZACAO,
       A.STATE                                                             AS STATUS_OS,
       A.MCH_CODE                                                          AS SERIAL,
       D.ACTUAL_OBJECT_ID                                                  AS SERIAL_ENTREGUE,
       COALESCE(IFSLAF.EQUIPMENT_SERIAL_API.GET_PART_NO(D.ACTUAL_OBJECT_SITE, D.ACTUAL_OBJECT_ID), IFSLAF.EQUIPMENT_SERIAL_API.GET_PART_NO(A.MCH_CODE_CONTRACT, A.MCH_CODE)) AS ID_MATERIAL_SERIAL,
       A.MCH_CODE_CONTRACT                                                 AS ID_SITE,
       COALESCE(IFSLAF.FA_OBJECT_API.GET_CODE_H(IFSLAF.COMPANY_SITE_API.GET_COMPANY(A.MCH_CODE_CONTRACT), A.MCH_CODE), A.MCH_CODE_CONTRACT) AS ID_CODE_H_APR_CUSTO,
       IFSLAF.WORK_TYPE_API.GET_DESCRIPTION(A.WORK_TYPE_ID)                AS TIPO_OS,
       A.REG_DATE                                                          AS DATA_CRIACAO,
       A.REAL_S_DATE                                                       AS DATA_INICIO_REAL,
       A.REAL_F_DATE                                                       AS DATA_FINAL_REAL,
       MAX(E.ORDER_NO)                                                          AS OV_ENTREGA,
       MAX(E.CF$_PCP_DATE) + CASE TO_CHAR(MAX(E.CF$_PCP_DATE), 'D') WHEN '6' THEN 3 WHEN '7' THEN 2 ELSE 1 END AS DATA_LOGISTICA,
       MAX(E.CF$_QTDE_REAGENDAMENTO_LOG)                                        AS QTDE_REAGENDAMENTO,
       IFSLAF.JT_TASK_COST_LINE_UTIL_API.GET_SUM_ACTUAL_COST(A.WO_NO, 'P') AS CUSTO_PESSOAL,
       IFSLAF.JT_TASK_COST_LINE_UTIL_API.GET_SUM_ACTUAL_COST(A.WO_NO, 'F') AS CUSTO_PRECO_FIXO,
       IFSLAF.JT_TASK_COST_LINE_UTIL_API.GET_SUM_ACTUAL_COST(A.WO_NO, 'X') AS CUSTO_DESPESAS,
       IFSLAF.JT_TASK_COST_LINE_UTIL_API.GET_SUM_ACTUAL_COST(A.WO_NO, 'M') AS CUSTO_MATERIAL,
       IFSLAF.JT_TASK_COST_LINE_UTIL_API.GET_SUM_ACTUAL_COST(A.WO_NO, 'T') AS CUSTO_FERRAMENTA,
       IFSLAF.JT_TASK_COST_LINE_UTIL_API.GET_SUM_ACTUAL_COST(A.WO_NO, 'E') AS CUSTO_EXTERNO
  FROM IFSLAF.WORK_ORDER A
  LEFT JOIN IFSLAF.CUSTOMER_ORDER F ON (A.CUST_ORDER_NO = F.ORDER_NO)
  LEFT JOIN IFSLAF.HISTORICAL_SEPARATE_UIV B ON (A.WO_NO = B.WO_NO)
  LEFT JOIN IFSLAF.ACTIVE_SEPARATE_UIV C ON (A.WO_NO = C.WO_NO)
 OUTER APPLY (SELECT D.ACTUAL_OBJECT_ID,
                     D.ACTUAL_OBJECT_SITE
                FROM IFSLAF.JT_TASK_UIV D
               WHERE (D.WO_NO = A.WO_NO)
                 AND (D.WORK_TYPE_ID IN ('DESM', 'MOB', 'MON', 'DES', 'SER'))
               ORDER BY D.WO_NO
               FETCH FIRST ROW ONLY) D
 LEFT JOIN IFSLAF.LAF_SUBTAB E ON (COALESCE(CAST(F.C_AGREEMENT_ID AS VARCHAR2(12)), F.QUOTATION_NO) = COALESCE(E.AGREEMENT_ID, E.QUOTATION_NO) AND D.ACTUAL_OBJECT_ID = E.SERIAL_NO)
 WHERE (A.WORK_TYPE_ID = 'MOB' OR A.WORK_TYPE_ID = 'DESM' OR A.WORK_TYPE_ID = 'SER' OR A.WORK_TYPE_ID = 'SER-T' OR A.WORK_TYPE_ID = 'SER-P')
 AND (A.STATE <> 'Cancelado') --AND A.WO_NO  = '81290'
 GROUP BY  F.QUOTATION_NO,
       F.C_AGREEMENT_ID,
       A.CUST_ORDER_NO,
       B.CUST_ORDER_LINE_NO,
       C.CUST_ORDER_LINE_NO,
       B.CUST_ORDER_REL_NO,
       C.CUST_ORDER_REL_NO,
       B.cust_order_line_item_no,
       C.cust_order_line_item_no,
       F.CUSTOMER_NO,
       A.WO_NO,
       A.ERR_DESCR,
       A.CONTRACT,
       A.ORG_CODE,
       A.STATE,
       A.MCH_CODE,
       D.ACTUAL_OBJECT_ID,
       D.ACTUAL_OBJECT_SITE,
       A.MCH_CODE_CONTRACT,
       A.WORK_TYPE_ID,
       A.REG_DATE,
       A.REAL_S_DATE,
       A.REAL_F_DATE
