WITH OF_PAI_CABECALHO AS (
    SELECT 
        A.ORDER_NO N_ORDEM,
        A.ORDER_CODE COD_ORDEM,
        A.CONTRACT ID_SITE,
        A.PART_NO ID_MATERIAL,
        IFSLAF.Inventory_Part_API.Get_Description(A.CONTRACT, A.PART_NO) DESC_MATERIAL,
        A.ENG_CHG_LEVEL N_REVISAO_ENG, 
        IFSLAF.SHOP_ORDER_COST_UTIL_API.Get_Actual_Start_Date(A.ORDER_NO, A.RELEASE_NO, A.SEQUENCE_NO) AS DATA_INICIO_REAL,
        A.REVISED_START_DATE DATA_INICIO,
        A.QTY_COMPLETE QTDE_ORDEM,
        A.PRE_ACCOUNTING_ID ID_PRE_ACCOUNTING,
        A.PROJECT_ID ID_PROJETO,
        A.release_no,
        A.SEQUENCE_NO
    FROM IFSLAF.SHOP_ORD A    
    
),
CUSTO_ESTRUTURA_OF AS (
    SELECT 
        B.ORDER_NO N_ORDEM,
        B.PART_NO ID_MATERIAL_COMPONENTE,
        B.COST_BUCKET_ID COD_TIPO_CUSTO,
        B.COST_BUCKET_PUBLIC_TYPE DESC_TIPO_COD,
        SUM(B.ACCUM_COST) CUSTO_ACUMULADO,
        B.QUANTITY QTDE_COMPONENTE,
        B.OPERATION_NO AS COD_OPERACAO,
        B.release_no,
        B.contract AS id_site
    FROM IFSLAF.SO_ACTUAL_COST_DETAILS_UIV2 B  
    WHERE TRANSACTION_CODE IN ('SOISS',  'BACFLUSH', 'OPFEED', 'LABOR_RPT', 'UNISS', 'SUNREC')
    GROUP BY B.PART_NO, B.COST_BUCKET_ID, B.COST_BUCKET_PUBLIC_TYPE, B.QUANTITY, B.OPERATION_NO, B.contract, B.release_no, B.ORDER_NO
),
CUSTO_OF_COMPLETA AS (
    SELECT 
        OF_PAI_CABECALHO.N_ORDEM,
        OF_PAI_CABECALHO.COD_ORDEM,
        OF_PAI_CABECALHO.ID_SITE,
        OF_PAI_CABECALHO.ID_MATERIAL,
        OF_PAI_CABECALHO.DESC_MATERIAL,
        OF_PAI_CABECALHO.N_REVISAO_ENG,
        OF_PAI_CABECALHO.DATA_INICIO_REAL,
        OF_PAI_CABECALHO.DATA_INICIO,
        OF_PAI_CABECALHO.QTDE_ORDEM,
        OF_PAI_CABECALHO.ID_PRE_ACCOUNTING,
        OF_PAI_CABECALHO.ID_PROJETO,
        OF_PAI_CABECALHO.release_no,
        OF_PAI_CABECALHO.SEQUENCE_NO,
        IFSLAF.INVENTORY_PART_API.Get_Description(CUSTO_ESTRUTURA_OF.ID_SITE, CUSTO_ESTRUTURA_OF.ID_MATERIAL_COMPONENTE) DESC_MATERIAL_COMPONENTE,
        CUSTO_ESTRUTURA_OF.ID_MATERIAL_COMPONENTE,
        CUSTO_ESTRUTURA_OF.COD_TIPO_CUSTO,
        CUSTO_ESTRUTURA_OF.DESC_TIPO_COD,
        CUSTO_ESTRUTURA_OF.CUSTO_ACUMULADO,
        CUSTO_ESTRUTURA_OF.QTDE_COMPONENTE,
        CUSTO_ESTRUTURA_OF.COD_OPERACAO,
        CUSTO_ESTRUTURA_OF.release_no AS release_no_component,
        IFSLAF.Shop_Order_Operation_API.Get_Operation_Description(OF_PAI_CABECALHO.N_ORDEM, OF_PAI_CABECALHO.RELEASE_NO, OF_PAI_CABECALHO.SEQUENCE_NO, CUSTO_ESTRUTURA_OF.COD_OPERACAO) AS DESC_OPERACAO,
        N_ORDEM_INTERMEDIARIO,
        DATA_RECEBIMENTO,
        ROW_NUMBER() OVER(PARTITION BY OF_PAI_CABECALHO.N_ORDEM, CUSTO_ESTRUTURA_OF.ID_MATERIAL_COMPONENTE, CUSTO_ESTRUTURA_OF.COD_TIPO_CUSTO ORDER BY A.DATA_RECEBIMENTO DESC NULLS LAST) AS RN
    FROM OF_PAI_CABECALHO
    LEFT JOIN CUSTO_ESTRUTURA_OF
        ON OF_PAI_CABECALHO.N_ORDEM = CUSTO_ESTRUTURA_OF.N_ORDEM
    LEFT JOIN (    SELECT 
                        PART_NO AS ID_MATERIAL,
                        IFSLAF.Inventory_Part_API.Get_Description(CONTRACT, PART_NO) DESC_MATERIAL,
                        SOURCE_REF1 AS N_ORDEM_INTERMEDIARIO,
                        DATE_APPLIED AS DATA_RECEBIMENTO
                    FROM ifslaf.INVENTORY_TRANSACTION_HIST  
                    WHERE  transaction_code = 'OOREC'
                    AND CONTRACT = '14') A
       ON A.ID_MATERIAL = CUSTO_ESTRUTURA_OF.ID_MATERIAL_COMPONENTE 
       AND (OF_PAI_CABECALHO.DATA_INICIO_REAL >= A.DATA_RECEBIMENTO OR A.N_ORDEM_INTERMEDIARIO IS NULL)
)                 

SELECT 
    OF_PAI_CABECALHO.N_ORDEM,
    OF_PAI_CABECALHO.ID_SITE,
    OF_PAI_CABECALHO.ID_MATERIAL,
    OF_PAI_CABECALHO.DESC_MATERIAL,
    OF_PAI_CABECALHO.N_REVISAO_ENG,
    OF_PAI_CABECALHO.DATA_INICIO_REAL, 
    OF_PAI_CABECALHO.DATA_INICIO,
    OF_PAI_CABECALHO.QTDE_ORDEM,
    
    CUSTO_OF_COMPLETA.ID_MATERIAL_COMPONENTE,
    CUSTO_OF_COMPLETA.DESC_MATERIAL_COMPONENTE,
    CASE
        WHEN OF_PAI_CABECALHO.ID_MATERIAL = CUSTO_OF_COMPLETA.ID_MATERIAL_COMPONENTE THEN NULL 
        ELSE CUSTO_OF_COMPLETA.N_ORDEM_INTERMEDIARIO END ULTIMA_OF_COMPONENTE,
    CUSTO_OF_COMPLETA.DATA_RECEBIMENTO AS DATA_RECEBIMENTO_OF_COMPONENTE,
    CUSTO_OF_COMPLETA.COD_TIPO_CUSTO,
    CUSTO_OF_COMPLETA.DESC_TIPO_COD AS DESC_TIPO_CUSTO,
    CUSTO_OF_COMPLETA.CUSTO_ACUMULADO,
    CUSTO_OF_COMPLETA.QTDE_COMPONENTE,
    CUSTO_OF_COMPLETA.COD_OPERACAO,
    CUSTO_OF_COMPLETA.DESC_OPERACAO, 
    
    OF_PAI_CABECALHO.ID_PRE_ACCOUNTING,
    OF_PAI_CABECALHO.ID_PROJETO,
    
    C.ACCOUNT_NO ID_CODE_A_CONTA_CONTAB,
    C.CODENO_B ID_CODE_B_CR,
    C.CODENO_C ID_CODE_C_SITE,
    C.CODENO_D ID_CODE_D_NATUREZA,
    C.CODENO_E ID_CODE_E_ATIVO,
    C.CODENO_F ID_CODE_F_PROJETO,
    C.CODENO_G ID_CODE_G_LINHA,
    C.CODENO_H ID_CODE_H_APR_CUSTO,
    C.CODENO_I ID_CODE_I_NEGOCIO
    
FROM OF_PAI_CABECALHO
LEFT JOIN CUSTO_OF_COMPLETA
    ON OF_PAI_CABECALHO.N_ORDEM = CUSTO_OF_COMPLETA.N_ORDEM AND CUSTO_OF_COMPLETA.RN = 1
LEFT JOIN IFSLAF.PRE_ACCOUNTING C
    ON C.PRE_ACCOUNTING_ID = OF_PAI_CABECALHO.ID_PRE_ACCOUNTING
