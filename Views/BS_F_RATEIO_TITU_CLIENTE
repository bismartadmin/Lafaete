WITH PURCHASE_DATA AS (
    SELECT 
        CO.INVOICE_ID,
        CO.ORDER_NO,
        CO.LINE_NO,
        CO.RELEASE_NO,
        ROW_NUMBER() OVER (PARTITION BY CO.INVOICE_ID ORDER BY CO.ORDER_NO) AS RN
        FROM IFSLAF.CUST_ORDER_INV_ITEM_UIV_ALL CO
)
SELECT 
        A.COMPANY,
        A.INVOICE_ID,
        A.INVOICE_NO,
        A.IDENTITY,
        A.PARTY_TYPE,
        A.CODE_A,
        COALESCE(IFSLAF.PRE_ACCOUNTING_API.get_codeno_b(IFSLAF.CUSTOMER_ORDER_LINE_API.GET_PRE_ACCOUNTING_ID(PD.ORDER_NO,PD.LINE_NO,PD.RELEASE_NO,'0')),A.CODE_B) CODE_B,
        COALESCE(IFSLAF.PRE_ACCOUNTING_API.get_codeno_c(IFSLAF.CUSTOMER_ORDER_LINE_API.GET_PRE_ACCOUNTING_ID(PD.ORDER_NO,PD.LINE_NO,PD.RELEASE_NO,'0')),A.CODE_C) CODE_C,
        COALESCE(IFSLAF.PRE_ACCOUNTING_API.get_codeno_d(IFSLAF.CUSTOMER_ORDER_LINE_API.GET_PRE_ACCOUNTING_ID(PD.ORDER_NO,PD.LINE_NO,PD.RELEASE_NO,'0')),A.CODE_D) CODE_D,
        COALESCE(IFSLAF.PRE_ACCOUNTING_API.get_codeno_e(IFSLAF.CUSTOMER_ORDER_LINE_API.GET_PRE_ACCOUNTING_ID(PD.ORDER_NO,PD.LINE_NO,PD.RELEASE_NO,'0')),A.CODE_E) CODE_E,
        COALESCE(IFSLAF.PRE_ACCOUNTING_API.get_codeno_f(IFSLAF.CUSTOMER_ORDER_LINE_API.GET_PRE_ACCOUNTING_ID(PD.ORDER_NO,PD.LINE_NO,PD.RELEASE_NO,'0')),A.CODE_F) CODE_F,
        COALESCE(IFSLAF.PRE_ACCOUNTING_API.get_codeno_g(IFSLAF.CUSTOMER_ORDER_LINE_API.GET_PRE_ACCOUNTING_ID(PD.ORDER_NO,PD.LINE_NO,PD.RELEASE_NO,'0')),A.CODE_G) CODE_G,
        COALESCE(IFSLAF.PRE_ACCOUNTING_API.get_codeno_h(IFSLAF.CUSTOMER_ORDER_LINE_API.GET_PRE_ACCOUNTING_ID(PD.ORDER_NO,PD.LINE_NO,PD.RELEASE_NO,'0')),A.CODE_H) CODE_H,
        COALESCE(IFSLAF.PRE_ACCOUNTING_API.get_codeno_i(IFSLAF.CUSTOMER_ORDER_LINE_API.GET_PRE_ACCOUNTING_ID(PD.ORDER_NO,PD.LINE_NO,PD.RELEASE_NO,'0')),A.CODE_I) CODE_I,
        COALESCE(IFSLAF.PRE_ACCOUNTING_API.get_codeno_j(IFSLAF.CUSTOMER_ORDER_LINE_API.GET_PRE_ACCOUNTING_ID(PD.ORDER_NO,PD.LINE_NO,PD.RELEASE_NO,'0')),A.CODE_J) CODE_J,
        A.INV_DOM_AMOUNT,
        A.INV_DOM_AMOUNT/IFSLAF.MAN_CUST_INVOICE_API.Get_Actual_Net_Dom_Amount(A.company, A.invoice_id) AS percent
    FROM
        IFSLAF.CUST_INV_INTEREST_FINE_QRY A
    LEFT JOIN PURCHASE_DATA PD ON PD.INVOICE_ID = A.INVOICE_ID AND PD.RN = 1  -- Garante que apenas uma linha seja selecionada para cada INVOICE_ID
