WITH OV_LINHA AS(
    SELECT 
        COL.ORDER_NO ,
        COL.C_SERIAL_NO,
        COL.C_START_BILLING_DATE,
        COL.C_END_BILLING_DATE,
        COL.COMPANY,
        COL.CONTRACT,
        COL.customer_no,
        COL.REL_NO,
        COL.LINE_NO,
        ifslaf.IDENTITY_INVOICE_INFO_API.Get_Identity_Type(company_ => COL.COMPANY, identity_ => COL.customer_no,  party_type_ => 'Cliente') AS TIPO_PARCEIRO
    FROM ifslaf.CUSTOMER_ORDER_LINE COL
),
OV_CAB AS (
    SELECT 
       CO.ORDER_NO,
       CO.ORDER_ID,
       CO.STATE,
       CO.C_AGREEMENT_ID,
       CO.C_OPPORTUNITY_NO,
       CO.CONTRACT,
       CO.company,
       CO.CUSTOMER_NO,
       ifslaf.customer_info_api.Get_Name(CO.CUSTOMER_NO) AS DESC_CLIENTE
    FROM ifslaf.CUSTOMER_ORDER CO
    WHERE CO.ORDER_ID = 'OL'
),
NF_ITEM AS (
    SELECT 
       NFI.FISCAL_NOTE_ID,
       NFI.PART_NO,
       NFI.PRODUCT_DESCRIPTION,
       NFI.COFINS_ST_VALUE,
       NFI.PIS_VALUE,
       NFI.NBM_ID,
       NFI.COFINS_VALUE,
       NFI.COFINS_TO_RETAIN_VALUE,
       NFI.IR_TO_RETAIN_VALUE,
       NFI.PIS_TO_RETAIN_VALUE,
       NFI.DISCOUNT_VALUE,
       NFI.UNITARY_GROSS_PRICE,
       NFI.ITEM_QUANTITY,
       ifslaf.Fn_Cust_Purc_Order_API.Get_Order_No(NFI.FISCAL_NOTE_ID, NFI.ITEM_NUMBER) AS ORDER_NO,
       ifslaf.Fn_Cust_Purc_Order_API.Get_Line_No(NFI.FISCAL_NOTE_ID, NFI.ITEM_NUMBER) AS LINE_NO,
       ifslaf.Fn_Cust_Purc_Order_API.Get_Rel_No(NFI.FISCAL_NOTE_ID, NFI.ITEM_NUMBER) AS REL_NO
    FROM ifslaf.FISCAL_NOTE_ITEM NFI
),
NF_CAB AS (
    SELECT 
       FN.FISCAL_NOTE_ID,
       FN.FISCAL_NOTE_NO,
       FN.invoice_id,
       FN.CREATION_DATE,
       FN.EMISSION_DATE,
       FN.ENTRY_DATE,
       FN.STATE , 
       FN.FISCAL_NOTE_TYPE
       
    FROM ifslaf.FISCAL_NOTE FN
    WHERE  FN.FISCAL_NOTE_TYPE = 'Ordem de Venda' 
    AND FN.STATE <> 'Cancelado'
)
SELECT 
       OV_CAB.ORDER_NO               AS N_ORDEM,
       OV_CAB.ORDER_ID               AS TIPO_ORDEM,
       OV_CAB.STATE                  AS STATUS_OV,
       OV_CAB.C_AGREEMENT_ID         AS N_CONTRATO,
       OV_CAB.C_OPPORTUNITY_NO       AS N_OPORTUNIDADE,
       OV_CAB.CONTRACT               AS ID_SITE,
       OV_CAB.company                AS ID_EMPRESA,
       OV_CAB.CUSTOMER_NO            AS ID_CLIENTE,
       ifslaf.customer_info_api.Get_Name(OV_CAB.CUSTOMER_NO) DESC_CLIENTE,             
       OV_LINHA.C_SERIAL_NO           AS ID_SERIAL,
       OV_LINHA.C_START_BILLING_DATE  AS DATA_INICIO_COBRANCA,
       OV_LINHA.C_END_BILLING_DATE    AS DATA_FINAL_COBRANCA,
       NF_ITEM.FISCAL_NOTE_ID        AS ID_NOTA_FISCAL,
       NF_CAB.FISCAL_NOTE_NO         AS N_NOTA_FISCAL,   
       NF_CAB.invoice_id             AS N_TITULO,
       ifslaf.IDENTITY_INVOICE_INFO_API.Get_Identity_Type(company_ => OV_LINHA.COMPANY, identity_ => OV_LINHA.customer_no,  party_type_ => 'Cliente') TIPO_PARCEIRO,
       NF_ITEM.PART_NO               AS ID_MATERIAL,
       NF_ITEM.PRODUCT_DESCRIPTION   AS DESC_MATERIAL,      
       NF_CAB.CREATION_DATE          AS DATA_CRIACAO,
       NF_CAB.EMISSION_DATE          AS DATA_EMISSAO,
       NF_CAB.ENTRY_DATE             AS DATA_LANCTO,
       NF_ITEM.COFINS_ST_VALUE       AS VALOR_COFINS,
       NF_ITEM.PIS_VALUE             AS VALOR_PIS,
       NF_ITEM.NBM_ID                AS NBM,
       NVL(NF_ITEM.UNITARY_GROSS_PRICE,0) * NF_ITEM.ITEM_QUANTITY AS VALOR_BRUTO,
       NVL(NF_ITEM.COFINS_VALUE, 0) AS COFINS_VALUE,
       NVL(NF_ITEM.PIS_VALUE, 0) AS PIS_VALUE,
       NVL(NF_ITEM.COFINS_TO_RETAIN_VALUE, 0) AS COFINS_RETIDO,
       NVL(NF_ITEM.IR_TO_RETAIN_VALUE, 0) AS IRRF_RETIDO,
       NVL(NF_ITEM.PIS_TO_RETAIN_VALUE, 0) AS PIS_RETIDO,
       NVL(NF_ITEM.DISCOUNT_VALUE, 0) AS DISCOUNT_VALUE,
       NVL(NF_ITEM.UNITARY_GROSS_PRICE * NF_ITEM.ITEM_QUANTITY,0) - NVL(NF_ITEM.COFINS_VALUE, 0) - NVL(NF_ITEM.PIS_VALUE, 0) - NVL(NF_ITEM.DISCOUNT_VALUE, 0) AS VALOR_LIQUIDO
FROM OV_LINHA
JOIN OV_CAB
    ON CONCAT(OV_LINHA.ORDER_NO,  OV_LINHA.CONTRACT) = CONCAT(OV_CAB.ORDER_NO,  OV_CAB.CONTRACT)
LEFT JOIN  NF_ITEM
    ON (OV_LINHA.ORDER_NO = NF_ITEM.ORDER_NO
    AND OV_LINHA.REL_NO = NF_ITEM.REL_NO
    AND OV_LINHA.LINE_NO = NF_ITEM.LINE_NO)
LEFT JOIN  NF_CAB
    ON NF_CAB.FISCAL_NOTE_ID = NF_ITEM.FISCAL_NOTE_ID
