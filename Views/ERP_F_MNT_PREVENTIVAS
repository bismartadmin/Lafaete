SELECT A1.SERIAL_NO AS SERIAL,
       A1.MCH_CODE  AS MCH_CODE,
       A1.PART_NO   AS ID_MATERIAL,
       A1.MCH_NAME  AS DESC_MATERIAL,
       IFSLAF.COMMODITY_GROUP_API.GET_DESCRIPTION(IFSLAF.INVENTORY_PART_API.GET_SECOND_COMMODITY(A1.CONTRACT, A1.PART_NO)) AS DESC_LINHA_PRODUTO,
       IFSLAF.COMMODITY_GROUP_API.GET_DESCRIPTION(IFSLAF.INVENTORY_PART_API.GET_PRIME_COMMODITY(A1.CONTRACT, A1.PART_NO)) AS DESC_GRUPO_PRODUTO,
       A1.COMPANY                                                    AS ID_EMPRESA,
       A1.CONTRACT                                                   AS ID_SITE,
       IFSLAF.FA_OBJECT_API.GET_CODE_H(A1.COMPANY, A1.SERIAL_NO)     AS ID_CODE_H_APR_CUSTO,
       NVL(A1.CF$_ITERNALUSEFLAG, 'NAO')                             AS USO_INTERNO,
       CASE A1.CF$_SALE_STATUS_DB WHEN '1' THEN 'SIM' ELSE 'NÃO' END AS DISPONIVEL_VENDA,
       CASE A1.CF$_SALE_STATUS_DB WHEN '2' THEN 'SIM' ELSE 'NÃO' END AS EXCLUSIVO_VENDA,
       A1.CF$_PRICEFORSALE                                           AS PRECO_VENDA,
       A1.CF$_DATE_EXLUSIVE_SALES                                    AS DATA_EXCLUSIVO_VENDA,
       A1.CF$_STATUS_EQUIPMENT                                       AS STATUS_EQUIPAMENTO,
       A1.CF$_STATUS_GERENCIAL                                       AS STATUS_GERENCIAL,
       A1.CF$_LOCEQUIP                                               AS LOCAL_EQUIPAMENTO,
       B1.OPPORTUNITY_NO                                             AS OPORTUNIDADE,
       B1.AGREEMENT_ID                                               AS N_CONTRATO,
       IFSLAF.CUSTOMER_INFO_API.GET_NAME(IFSLAF.C_RECURRENT_AGREEMENT_API.GET_CUSTOMER_ID(B1.OPPORTUNITY_NO, B1.AGREEMENT_ID)) AS DESC_CLIENTE,
       E1.ULTIMA_OS_PREVENTIVA,
       E1.ULTIMA_PREVENTIVA_REALIZADA,
       E1.DATA_LANCTO_ULT_PREV,
       E1.DATA_TERMINO_ULT_PREV,
       D1.HORIMETRO_ULT_PREV,
       C1.HORIMETRO_ATUAL,
       C1.DATA_HORIMETRO_ATUAL,
       D1.HORIMETRO_ULT_PREV + 500 AS PROX_PREVENTIVA,
       COALESCE((D1.HORIMETRO_ULT_PREV + 500 - C1.HORIMETRO_ATUAL), G1.RESTANTE_A_VENCER) AS HORAS_PROX_PREV,
       F1.OS_ATUAL,
       F1.TIPO_OS_ATUAL,
       F1.STATUS_OS_ATUAL,
       F1.DATA_LANCTO_OS_ATUAL,
       G1.PROXIMA_PREVENTIVA_PMP,
       G1.DESC_PROXIMA_PREV_PMP,
       G1.DATA_PROXIMA_PREV_PMP,
       G1.VALOR_PROXIMA_PREV_PMP
  FROM IFSLAF.EQUIPMENT_SERIAL_CFV A1
  LEFT JOIN (SELECT F.SERIAL_NO,
                    F.OPPORTUNITY_NO,
                    F.AGREEMENT_ID
               FROM IFSLAF.C_REC_AGREEMENT_RENTED_ASSET F
              WHERE NVL(F.RENTED_ASSET, 'FALSE') = 'TRUE') B1 ON (A1.SERIAL_NO = B1.SERIAL_NO)
  LEFT JOIN (SELECT C.MCH_CODE,
                    C.MEASURED_VALUE  AS HORIMETRO_ATUAL,
                    TRUNC(C.REG_DATE) AS DATA_HORIMETRO_ATUAL
               FROM IFSLAF.EQUIP_OBJECT_MEAS_GROUP C
              WHERE C.PARAMETER_CODE = 'HR') C1 ON (A1.MCH_CODE = C1.MCH_CODE)
 OUTER APPLY (SELECT D.MEASURED_VALUE AS HORIMETRO_ULT_PREV 
                FROM IFSLAF.EQUIPMENT_OBJECT_MEAS D
               WHERE D.PARAMETER_CODE = 'HR'
                 AND D.MEASUREMENT_TYPE_DB = 'RecordedReading'
                 AND D.MCH_CODE = A1.MCH_CODE
                 AND TRUNC(D.REG_DATE) = (SELECT TRUNC(MAX(B.REAL_F_DATE))
                                            FROM IFSLAF.WORK_ORDER B
                                           WHERE B.OBJSTATE = 'FINISHED'
                                             AND B.WORK_TYPE_ID = 'PRE'
                                             AND B.MCH_CODE = D.MCH_CODE)
            ORDER BY D.MEASURED_VALUE DESC
               FETCH FIRST ROW ONLY) D1
 OUTER APPLY (SELECT B.WO_NO          AS ULTIMA_OS_PREVENTIVA,
                     B.ERR_DESCR      AS ULTIMA_PREVENTIVA_REALIZADA,
                     B.REG_DATE       AS DATA_LANCTO_ULT_PREV,
                     B.REAL_F_DATE    AS DATA_TERMINO_ULT_PREV
                FROM IFSLAF.WORK_ORDER B
               WHERE B.OBJSTATE     = 'FINISHED'
                 AND B.WORK_TYPE_ID = 'PRE'
                 AND B.MCH_CODE     = A1.MCH_CODE
            ORDER BY B.REAL_F_DATE DESC FETCH FIRST ROW ONLY) E1
 OUTER APPLY (SELECT B.WO_NO          AS OS_ATUAL,
                     B.WORK_TYPE_ID   AS TIPO_OS_ATUAL,
                     B.STATE          AS STATUS_OS_ATUAL,
                     B.REG_DATE       AS DATA_LANCTO_OS_ATUAL
                FROM IFSLAF.WORK_ORDER B
               WHERE B.OBJSTATE NOT IN ('CANCELED', 'FINISHED')
                 AND B.WORK_TYPE_ID IN ('PRE', 'COR')
                 AND B.MCH_CODE = A1.MCH_CODE
            ORDER BY B.WO_NO DESC
               FETCH FIRST ROW ONLY) F1
 OUTER APPLY (SELECT E.ACTION_CODE_ID AS PROXIMA_PREVENTIVA_PMP,
                     IFSLAF.PM_PROGRAM_API.GET_DESCRIPTION(E.PM_PROGRAM_ID, E.PM_PROGRAM_REV) AS DESC_PROXIMA_PREV_PMP,
                     E.PLANNED_DATE   AS DATA_PROXIMA_PREV_PMP,
                     E.REMAINING_TO_DUE AS RESTANTE_A_VENCER,
                     E.BASE_PLANNED_VALUE AS VALOR_PROXIMA_PREV_PMP
                FROM IFSLAF.PM_CALENDAR_PLAN E
               WHERE IFSLAF.PM_ACTION_API.GET_PM_STATE(E.PM_NO, E.PM_REVISION) = 'Active'
                 AND E.WO_NO IS NULL
                 AND E.MCH_CODE = A1.SERIAL_NO
            ORDER BY E.PLANNED_DATE,
                     E.PM_NO DESC
               FETCH FIRST ROW ONLY) G1
 WHERE IFSLAF.INVENTORY_PART_API.GET_PRIME_COMMODITY(A1.CONTRACT, A1.PART_NO) IN ('V04', 'V06')
   AND A1.CF$_STATUS_GERENCIAL <> 'Baixado'
