SELECT A.OPPORTUNITY_NO                                                                                                                 ID_OPORTUNIDADE,
       A.AGREEMENT_ID                                                                                                                   N_CONTRATO,
       IFSLAF.C_RECURRENT_AGREEMENT_API.GET_CUSTOMER_ID(A.OPPORTUNITY_NO, A.AGREEMENT_ID)                                               ID_CLIENTE,
       IFSLAF.CUSTOMER_INFO_API.GET_NAME(IFSLAF.C_RECURRENT_AGREEMENT_API.GET_CUSTOMER_ID(A.OPPORTUNITY_NO, A.AGREEMENT_ID))            DESC_CLIENTE,
       IFSLAF.IDENTITY_INVOICE_INFO_API.GET_IDENTITY_TYPE(IFSLAF.COMPANY_SITE_API.GET_COMPANY(A.CONTRACT), 
       IFSLAF.C_RECURRENT_AGREEMENT_API.GET_CUSTOMER_ID(A.OPPORTUNITY_NO, A.AGREEMENT_ID),
       IFSLAF.CUSTOMER_INFO_API.GET_PARTY_TYPE(IFSLAF.C_RECURRENT_AGREEMENT_API.GET_CUSTOMER_ID(A.OPPORTUNITY_NO, A.AGREEMENT_ID)))     TIPO_CLIENTE,
       IFSLAF.COMPANY_SITE_API.GET_COMPANY(A.CONTRACT)                                                                                  ID_EMPRESA,
       A.CONTRACT                                                                                                                       ID_SITE,
       IFSLAF.C_RECURRENT_AGREEMENT_API.Get_Salesman_Code(A.OPPORTUNITY_NO, A.AGREEMENT_ID)                                             ID_REPRESENTANTE,
       A.LINE_NO                                                                                                                        N_LINHA,
       IFSLAF.C_REC_AGREEMENT_ITEM_API.GET_LINE_NAME(A.OPPORTUNITY_NO, A.AGREEMENT_ID, A.LINE_NO)                                       NOME_LINHA,
       A.CATALOG_NO                                                                                                                     ID_MATERIAL,
       IFSLAF.SALES_PART_API.GET_CATALOG_DESC(A.CONTRACT, A.CATALOG_NO)                                                                 DESC_MATERIAL,
       A.SERIAL_NO                                                                                                                      SERIAL,
       d.rental_price                                                                                                                   VALOR_HORA_TABELA,
       NVL((D.rental_price * (1 - nvl(D.discount,0))),0)                                                                                VALOR_HORA,
       a.month_value                                                                                                                    VALOR_MENSAL,        
       ((SELECT MAX(B.VALUE) FROM IFSLAF.USRDEFINED_BASE_VALUE B WHERE A.SERIAL_NO = B.OBJECT_ID)/ (1 - 0.0925))                        VALOR_AQUISICAO,
       ((SELECT MAX(B.VALUE) FROM IFSLAF.USRDEFINED_BASE_VALUE B WHERE A.SERIAL_NO = B.OBJECT_ID)/ (1 - 0.0925))   * 0.05               RENTAL_RATE,
       TRUNC(A.START_DATE)                                                                                                              DATA_INICIO_LOCACAO, 
       a.delivery_fiscal_note_id                                                                                                        ID_NF_REMESSA,
       TRUNC(A.DELIVERY_DATE)                                                                                                           DATA_REMESSA,
       A.return_fiscal_note_id                                                                                                          ID_NF_RETORNO,
       TRUNC(A.FINISH_DATE)                                                                                                             DATA_FIM_LOCACAO,
       TRUNC(A.RETURN_DATE)                                                                                                             DATA_RETORNO,
       (SELECT f.creation_date FROM IFSLAF.FISCAL_NOTE f WHERE f.fiscal_note_id = A.return_fiscal_note_id  )                            DATA_CRIACAO_NF_RETORNO,
       A.order_no                                                                                                                       ID_OV_ORIGEM,
       A.line_no                                                                                                                        ID_LINHA_OV_ORIGEM,
       A.seq_no                                                                                                                         ID_ENTREGA_OV_ORIGEM,
       CASE WHEN A.RENTED_ASSET = 'TRUE' THEN 'SIM' ELSE 'NAO' END                                                                      LOCADO,
       CASE WHEN A.CHECKLIST_FINISHED = 'TRUE' THEN 'SIM' ELSE 'NAO' END                                                                CHECKLIST_FINALIZADO,
       TRUNC(IFSLAF.C_REC_AGREEMENT_INFO_API.GET_NEXT_BILLING_REF_DATE(A.OPPORTUNITY_NO, A.AGREEMENT_ID))                               DATA_PROX_FATURAMENTO,
       TRUNC(IFSLAF.C_RECURRENT_AGREEMENT_API.GET_END_PLANNED_DATE(A.OPPORTUNITY_NO, A.AGREEMENT_ID))                                   DATA_FINAL_PLANEJADA,
       C.cf$_Transferred_To                                                                                                             TRANSFERIDO_PARA,
       C.CF$_REPLACEMENT_APPROVED                                                                                                       SUBSTITUICAO_APROVADA,
       NVL(C.CF$_FICHA_VISTORIA,'NAO')                                                                                                  FICHA_VISTORIA_ASSINADA,
       NVL(C.CF$_NF_REMESSA,'NAO')                                                                                                      NF_REMESSA_ASSINADA,
       NVL(C.CF$_ORDEM_SERVICO,'NAO')                                                                                                   OS_ASSINADA,
       C.CF$_OBSERVACOES                                                                                                                OBSERVACOES,
       A.OBJKEY,
       B.OBJKEY AS OBJKEY_SERIAL
  FROM IFSLAF.C_REC_AGREEMENT_RENTED_ASSET A
  LEFT JOIN IFSLAF.EQUIPMENT_SERIAL_UIV B ON (A.CONTRACT = B.CONTRACT AND A.SERIAL_NO = B.MCH_CODE)
  LEFT JOIN IFSLAF.C_REC_AGREE_IT_PROD_LINE_CFV C ON (A.OBJKEY = C.OBJKEY)
  LEFT JOIN IFSLAF.C_REC_AGREEMENT_ITEM_PROD D ON (A.AGREEMENT_ID = D.AGREEMENT_ID AND A.LINE_NO = D.LINE_NO AND D.CATALOG_NO = A.CATALOG_NO AND D.SEQ_NO = A.SEQ_NO)
