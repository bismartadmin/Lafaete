select SUBTAB.ID_EMPRESA,
       SUBTAB.TITULO,
       SUBTAB.PARCELA,
       SUBTAB.TIPO_TITULO,
       SUBTAB.ID_CLIENTE,
       SUBTAB.DESC_CLIENTE,
       SUBTAB.DATA_TITULO,
       SUBTAB.DATA_VENCIMENTO,
       SUBTAB.DATA_VENCIMENTO_ORIGINAL,
       SUBTAB.VALOR_PARCELA,
       SUBTAB.VALOR_EM_ABERTO,
       SUBTAB.VALOR_PAGO,
       SUBTAB.VALOR_MULTA,
       SUBTAB.VALOR_JUROS,
       SUBTAB.VALOR_BAIXADO,
       SUBTAB.TOTAL_PAGO,
       SUBTAB.BLOCO
FROM (
select a.company ID_EMPRESA,
       A.ledger_item_id TITULO,
       A.INSTALLMENT_ID PARCELA,
       A.ledger_item_series_id TIPO_TITULO,
       A.identity ID_CLIENTE,
       A.identity_name DESC_CLIENTE,
       A.LEDGER_DATE DATA_TITULO,
       A.DUE_DATE DATA_VENCIMENTO,
       (SELECT C.DUE_DATE
          FROM IFSLAF.ABSTRACT_PAYMENT_PLAN2 C
         WHERE C.INVOICE_ID = A.INVOICE_ID
           AND C.INSTALLMENT_ID = A.INSTALLMENT_ID
           AND C.IDENTITY = A.IDENTITY) DATA_VENCIMENTO_ORIGINAL,
       A.open_amount VALOR_PARCELA,
       A.open_amount VALOR_EM_ABERTO,
       0 VALOR_PAGO,
       0   VALOR_MULTA,
       0 VALOR_JUROS,
       0 VALOR_BAIXADO,
       0 TOTAL_PAGO,
       'A' BLOCO
from ifslaf.SUPP_INV_INTEREST_FINE_QRY a
where a.CLIENT_INV_STATE <> 'Cancelado' 
and a.OPEN_AMOUNT > 0

UNION ALL

SELECT A.company ID_EMPRESA,
       A.ledger_item_id TITULO,
       A.INSTALLMENT_ID PARCELA,
       A.ledger_item_series_id TIPO_TITULO,
       A.identity ID_CLIENTE,
       A.identity_name DESC_CLIENTE,
       A.LEDGER_DATE DATA_TITULO,
       A.DUE_DATE DATA_VENCIMENTO,
       (SELECT C.DUE_DATE
          FROM IFSLAF.ABSTRACT_PAYMENT_PLAN2 C
         WHERE C.INVOICE_ID = A.INVOICE_ID
           AND C.INSTALLMENT_ID = A.INSTALLMENT_ID
           AND C.IDENTITY = A.IDENTITY) DATA_VENCIMENTO_ORIGINAL,
       b.PAID_AMOUNT VALOR_PARCELA,
       0 VALOR_EM_ABERTO,
       b.PAID_AMOUNT VALOR_PAGO,
       NVL(B.FINE_CURR_AMOUNT,0)  VALOR_MULTA,
       NVL(B.INTEREST_CURR_AMOUNT,0) VALOR_JUROS,
       NVL(B.USED_DISCOUNT,0) + NVL(B.WRITE_OFF_CURR_AMOUNT,0) VALOR_BAIXADO,
       b.PAID_AMOUNT + NVL(B.FINE_CURR_AMOUNT,0) + NVL(B.INTEREST_CURR_AMOUNT,0) - NVL(B.USED_DISCOUNT,0) - NVL(B.WRITE_OFF_CURR_AMOUNT,0) TOTAL_PAGO,
       'B' BLOCO
FROM IFSLAF.SUPP_INV_INTEREST_FINE_QRY A
       LEFT JOIN IFSLAF.LEDGER_TRANSACTION_SU_QRY B ON (A.COMPANY = B.COMPANY AND A.IDENTITY = B.IDENTITY AND A.PARTY_TYPE_DB = B.PARTY_TYPE_DB AND A.LEDGER_ITEM_ID = B.LEDGER_ITEM_ID AND A.LEDGER_ITEM_SERIES_ID = B.LEDGER_ITEM_SERIES_ID AND A.LEDGER_ITEM_VERSION = B.LEDGER_ITEM_VERSION AND A.INSTALLMENT_ID = B.INSTALLMENT_ID AND B.ROLLEDBACK = 'FALSE' AND B.PAYMENT_TYPE_CODE NOT IN ('COMPSUPPROLLBACK', 'TAXWITHHOLD'))
) SUBTAB
WHERE ((SUBTAB.TOTAL_PAGO + SUBTAB.VALOR_EM_ABERTO) > 0)
