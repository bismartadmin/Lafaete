WITH SUBTB2(ANO_MES, ANO, MES) AS (
      SELECT TO_CHAR(ADD_MONTHS(DATE '2023-01-01', LEVEL - 1), 'YYYYMM'),
              TO_CHAR(ADD_MONTHS(DATE '2023-01-01', LEVEL - 1), 'YYYY'),
              TO_CHAR(ADD_MONTHS(DATE '2023-01-01', LEVEL - 1), 'MM')
      FROM DUAL
CONNECT BY ADD_MONTHS(TO_DATE('2023-01-01','YYYY-MM-DD'), LEVEL - 1) < SYSDATE)
SELECT A.COMPANY                  AS "Empresa",
       (SELECT CNPJ FROM ifslaf.COMPANY_BR_TAX_INFO WHERE COMPANY = A.COMPANY)         CNPJ,
       SUBTAB.MES                 AS "Mês",
       SUBTAB.ANO                 AS "Ano",
       A.ITEM_ABOVE               AS CONTA_SUPERIOR,
       A.NAME_VALUE               AS "Nº Conta",
       A.DESCRIPTION              AS "Descrição",
       SUM(SUBTAB.SALDO_INICIAL)  AS "Saldo Anterior",
       SUM(SUBTAB.DEBITO)         AS "Débito",
       SUM(SUBTAB.CREDITO)        AS "Crédito",
       SUM(SUBTAB.SALDO_MES)      AS "Saldo do Mês",
       SUM(SUBTAB.SALDO_INICIAL + SUBTAB.DEBITO - SUBTAB.CREDITO) AS "Saldo Final",
       A.OBJVERSION
FROM   (SELECT A.NAME_VALUE, SUBTB2.ANO, SUBTB2.MES, A.COMPANY,
               COALESCE((SELECT SUM(B.AMOUNT_BALANCE)
                         FROM ifslaf.ACCOUNTING_BALANCE_AUTH B
                         WHERE B.COMPANY = A.COMPANY
                         AND B.ACCOUNT = A.NAME_VALUE
                         AND B.ACCOUNTING_YEAR = SUBTB2.ANO
                         AND B.ACCOUNTING_PERIOD < SUBTB2.MES), 0) AS SALDO_INICIAL,
               COALESCE((SELECT SUM(B.DEBET_BALANCE)
                         FROM ifslaf.ACCOUNTING_BALANCE_AUTH B
                         WHERE B.COMPANY = A.COMPANY
                         AND B.ACCOUNT = A.NAME_VALUE
                         AND B.YEAR_PERIOD = (SUBTB2.ANO ||'-'|| LPAD(SUBTB2.MES, 2, '0'))), 0) AS DEBITO,
               COALESCE((SELECT SUM(B.CREDIT_BALANCE)
                         FROM ifslaf.ACCOUNTING_BALANCE_AUTH B
                         WHERE B.COMPANY = A.COMPANY
                         AND B.ACCOUNT = A.NAME_VALUE
                         AND B.YEAR_PERIOD = (SUBTB2.ANO ||'-'|| LPAD(SUBTB2.MES, 2, '0'))), 0) AS CREDITO,
               COALESCE((SELECT SUM(NVL(B.DEBET_AMOUNT, 0) - NVL(B.CREDIT_AMOUNT, 0))
                         FROM ifslaf.GEN_LED_VOUCHER_ROW B
                         WHERE B.COMPANY = A.COMPANY
                         AND B.ACCOUNT = A.NAME_VALUE
                         AND B.YEAR_PERIOD_KEY = TO_NUMBER(SUBTB2.ANO || LPAD(SUBTB2.MES, 2, '0'))), 0) AS SALDO_MES
          FROM ifslaf.ACCOUNTING_STRUCTURE_ITEM A
          CROSS JOIN SUBTB2
          WHERE  A.STRUCTURE_ID = 'BALANCETE' AND A.STRUCTURE_ITEM_TYPE_DB = '2') SUBTAB
          INNER JOIN ifslaf.ACCOUNTING_STRUCTURE_ITEM A ON (SUBTAB.COMPANY = A.COMPANY AND SUBTAB.NAME_VALUE LIKE REGEXP_REPLACE(A.NAME_VALUE, '[^0-9]', '') || '%')
WHERE A.STRUCTURE_ID = 'BALANCETE' AND (SUBTAB.SALDO_INICIAL <> 0 OR SUBTAB.DEBITO <> 0 OR SUBTAB.CREDITO <> 0)
 
GROUP BY A.COMPANY, A.NAME_VALUE, A.ITEM_ABOVE, A.DESCRIPTION, A.SORT_ORDER, A.LEVEL_ID, SUBTAB.ANO, SUBTAB.MES, A.OBJVERSION
ORDER BY A.NAME_VALUE, A.ITEM_ABOVE, A.SORT_ORDER, A.LEVEL_ID
