SELECT OS.WO_NO AS ORDEM_SERVICO,
       OS.C_AGREEMENT_ID AS CONTRATO,
       OS.CONTRACT AS SITE,
       OS.WORK_TYPE_ID AS TIPO_MANUT,
       IFSLAF.PERSON_INFO_API.GET_NAME(OS.REPORTED_BY) AS APONTADO_POR,
       OS.MCH_CODE AS PLACA,
       IFSLAF.ITEM_CLASS_API.GET_ITEM_CLASS_DESC(OS.ITEM_CLASS_ID) AS MODELO,
       OS.MCH_CODE_DESCRIPTION AS DESCRICAO,
       OBJ.CF$_LOCEQUIP AS LOCAL,
       OS.PLAN_S_DATE AS DATA_PROG,
       TAREFA.ACTUAL_START AS DATA_INICIO,
       TAREFA.ACTUAL_FINISH AS DATA_FINAL,
       (SELECT MAX(C.MEASURED_VALUE)
          FROM IFSLAF.EQUIPMENT_OBJECT_MEAS C
         WHERE C.MCH_CODE = OS.MCH_CODE
           AND TRUNC(C.REG_DATE) = (SELECT MAX(TO_DATE(A.ACTUAL_START))
                                      FROM IFSLAF.JT_TASK_UIV A
                                     WHERE A.WO_NO = (SELECT MAX(B.WO_NO)
                                                        FROM IFSLAF.HISTORICAL_SEPARATE_UIV B
                                                       WHERE B.WO_NO < OS.WO_NO
                                                         AND B.WORK_TYPE_ID = 'PRE'
                                                         AND B.MCH_CODE = C.MCH_CODE))) + 500 AS HR_PROG,
       MEDIDAS.MEASURED_VALUE AS HR_REAL,
       TAREFA.DESCRIPTION AS TAREFA,
       IFSLAF.INVENTORY_PART_API.GET_DESCRIPTION(MATERIAL.SPARE_CONTRACT, MATERIAL.PART_NO) AS MATERIAL,
       MATERIAL.PLAN_QTY AS QUANTIDADE,
       ETAPA.DESCRIPTION AS DESCRICAO_ETAPA,
       ETAPA.STATE AS STATUS,
       EXECUTANTE.RESOURCE_DESCRIPTION AS EXECUTANTE
  FROM IFSLAF.HISTORICAL_SEPARATE_UIV OS
 INNER JOIN IFSLAF.JT_TASK_UIV TAREFA ON (OS.WO_NO = TAREFA.WO_NO)
 INNER JOIN IFSLAF.EQUIPMENT_SERIAL_UIV_CFV OBJ ON (OS.MCH_CODE = OBJ.MCH_CODE)
  LEFT JOIN IFSLAF.EQUIPMENT_OBJECT_MEAS MEDIDAS ON (OS.MCH_CODE = MEDIDAS.MCH_CODE AND TRUNC(MEDIDAS.REG_DATE) = TRUNC(TAREFA.ACTUAL_FINISH) AND MEDIDAS.PARAMETER_CODE = 'HR' AND MEDIDAS.MEASUREMENT_TYPE = 'Leitura Registrada')
  LEFT JOIN IFSLAF.MAINT_MATERIAL_REQ_LINE_UIV MATERIAL ON (OS.WO_NO = MATERIAL.WO_NO AND TAREFA.TASK_SEQ = MATERIAL.TASK_SEQ)
  LEFT JOIN IFSLAF.JT_TASK_STEP_UIV ETAPA ON (TAREFA.TASK_SEQ = ETAPA.TASK_SEQ)
  LEFT JOIN IFSLAF.JT_TASK_RESOURCE_UIV EXECUTANTE ON (OS.WO_NO = EXECUTANTE.WO_NO AND TAREFA.TASK_SEQ = EXECUTANTE.TASK_SEQ)
