SELECT A.OPPORTUNITY_NO ID_OPORTUNIDADE,
       A.DESCRIPTION DESC_OPORTUNIDADE,
       A.CUSTOMER_ID ID_CLIENTE,
       IFSLAF.CUSTOMER_INFO_API.GET_NAME(A.CUSTOMER_ID) DESC_CLIENTE,
       IFSLAF.CUSTOMER_INFO_API.GET_CUSTOMER_CATEGORY(A.CUSTOMER_ID) CATEGORIA_CLIENTE,
       IFSLAF.CORPORATE_FORM_API.Get_Corporate_Form_Desc(IFSLAF.CUSTOMER_INFO_API.Get_Country_Db(customer_id_ => A.customer_id),IFSLAF.CUSTOMER_INFO_API.Get_Corporate_Form(customer_id_ => A.customer_id)) ORIGEM_INTEGRACAO,
       A.COMPANY ID_EMPRESA,
       B.CONTRACT ID_SITE,
       A.PROBABILITY PROBABILIDADE_FECHAMENTO,
       A.OPPORTUNITY_TYPE TIPO_OPORTUNIDADE,
       A.SOURCE_ID DESC_ORIGEM_ATENDIMENTO,
       A.MARKET_CODE ID_MERCADO,
       IFSLAF.SALES_MARKET_API.Get_Description(A.MARKET_CODE) DESC_MERCADO,
       A.MAIN_CONTACT_ID ID_CONTATO,
       IFSLAF.Person_Info_API.Get_Name(A.MAIN_CONTACT_ID) DESC_CONTATO,
       A.MAIN_REPRESENTATIVE_ID ID_REPRESENTANTE,
       IFSLAF.Person_Info_API.Get_Name(A.MAIN_REPRESENTATIVE_ID) DESC_REPRESENTANTE,
       J.performed_by  USUARIO_ABERTURA,        
       A.DATE_ENTERED DATA_CRIACAO,
       A.CLOSURE_DATE DATA_FECHAMENTO,
       A.STATE || CASE WHEN NVL(A.CLOSED_STATUS, ' ') <> ' ' THEN ' - ' || A.CLOSED_STATUS END STATUS_OPORTUNIDADE_AJUST,
       CASE
          WHEN A.LOST_REASON_ID IS NOT NULL THEN
           IFSLAF.LOSE_WIN_REASON_API.GET_REASON_DESCRIPTION(LOST_REASON_ID)
          WHEN A.WON_REASON_ID IS NOT NULL THEN
           IFSLAF.LOSE_WIN_REASON_API.GET_REASON_DESCRIPTION(A.WON_REASON_ID)
          WHEN A.CANCELLATION_REASON IS NOT NULL THEN
           IFSLAF.ORDER_CANCEL_REASON_API.GET_REASON_DESCRIPTION(A.CANCELLATION_REASON)
          ELSE
           NULL
       END DESC_MOTIVO_PERDA_GANHO,
       C.QUOTATION_NO N_COTACAO,
       D.AGREEMENT_ID N_CONTRATO,
     --  case WHEN EXISTS (select  1 from ifslaf.Cc_Case_Task_Overview_Cfv l where (l.ACTIVITY_NAME like '%ORCAMENTO%' or l.ACTIVITY_NAME like '%PRECIFICA%') AND L.CF$_OPPORTUNITY_NO = to_char(a.opportunity_no)) THEN 'SIM' ELSE 'NAO' END EXISTE_ORCAMENTO,
       CASE WHEN EXISTS (SELECT 1 FROM IFSLAF.CUSTOMER_ORDER E WHERE E.C_OPPORTUNITY_NO = A.OPPORTUNITY_NO) THEN 'SIM' ELSE 'N√ÉO' END EXISTE_OV
                                                                                                                                      
  FROM IFSLAF.BUSINESS_OPPORTUNITY A
  LEFT JOIN IFSLAF.BUSINESS_OPPORTUNITY_SITE B ON (A.OPPORTUNITY_NO = B.OPPORTUNITY_NO)
  OUTER APPLY (SELECT C.quotation_no FROM IFSLAF.ORDER_QUOTATION C WHERE (A.OPPORTUNITY_NO = C.BUSINESS_OPPORTUNITY_NO)) C
  OUTER APPLY (SELECT D.agreement_id FROM IFSLAF.C_RECURRENT_AGREEMENT D WHERE (A.OPPORTUNITY_NO = D.OPPORTUNITY_NO)) D
  OUTER APPLY (SELECT J.performed_by FROM IFSLAF.BUSINESS_OPPORTUN_HISTORY J WHERE J.event = 'Status' AND J.new_value = 'Unconfirmed'  AND j.opportunity_no = a.opportunity_no ORDER BY j.history_no FETCH FIRST ROW ONLY) J
