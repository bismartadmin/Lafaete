SELECT 
    A.ID_EMPRESA,
    A.ID_EMPRESA_PAGTO,
    A.ID_CONTA_MOVIMENTO,
    A.DATA_LANCTO,
    A.DATA_PAGTO,
    A.N_LANCTO,
    A.ID_PAGTO,
    A.ID_TRANSACAO,
    A.SERIE_PAGTO, 
    A.TIPO_LANCTO,
    A.TIPO_PAGTO,
    coalesce(E.INVOICE_NO,A.N_TITULO)    AS N_TITULO,
    coalesce(E.INVOICE_ID,IFSLAF.INVOICE_API.Get_Invoice_Id_Db(A.ID_EMPRESA, A.ID_PARCEIRO, 'SUPPLIER', A.ID_SERIE, coalesce(E.INVOICE_NO,A.N_TITULO)),IFSLAF.INVOICE_API.Get_Invoice_Id_Db(A.ID_EMPRESA, A.ID_PARCEIRO, 'CUSTOMER', A.ID_SERIE, A.N_TITULO)) AS INVOICE_ID,
    A.ID_PARCELA,
    A.TIPO_TITULO,
    A.DATA_TITULO,
    A.DATA_VENCIMENTO_ORIGINAL,
    A.DATA_VENCIMENTO,
    A.ID_PARCEIRO,
    A.DESC_PARCEIRO,
    A.ESPECIE_PARCEIRO,
    A.TIPO_PARCEIRO,
    A.ID_RECEBEDOR,
    coalesce(b.code_a,A.ID_CODE_A)                              AS ID_CODE_A, 
    coalesce(d.code_b,c.code_b,b.code_b,A.ID_CODE_B)            AS ID_CODE_B,
    coalesce(d.code_c,c.code_c,b.code_c,A.ID_CODE_C)            AS ID_CODE_C,
    coalesce(d.code_d,c.code_d,b.code_d,A.ID_CODE_D)            AS ID_CODE_D,
    coalesce(d.code_e,c.code_e,b.code_e,A.ID_CODE_E)            AS ID_CODE_E,
    coalesce(d.code_f,c.code_f,b.code_f,A.ID_CODE_F)            AS ID_CODE_F,
    coalesce(d.code_g,c.code_g,b.code_g,A.ID_CODE_G)            AS ID_CODE_G,
    coalesce(d.code_h,c.code_h,b.code_h,A.ID_CODE_H)            AS ID_CODE_H,
    coalesce(d.code_i,c.code_i,b.code_i,A.ID_CODE_I)            AS ID_CODE_I,
    coalesce(d.code_j,c.code_j,b.code_j,A.ID_CODE_J)            AS ID_CODE_J,
    round((NVL(A.VALOR, 0) * nvl(E.PERCENT_GRUPO,1)) * coalesce(c.percent,b.percent,d.percent,1),4) AS VALOR, 
    A.TIPO_MOVIMENTO,
    A.OBJ_VERSION,
    A.TIPO_TRANSACAO,
    A.OBS,
    A.TITULO_ANTECIPADO,
    A.ID_SERIE,
    A.BLOCO_CODIGO,
    E.GROUP_ID as RATEIO_TITULO_AGRUPADO,
    B.INVOICE_ID AS RATEIO_TITULO_MANUAL,
    D.ORDER_NO AS RATEIO_OC,
    C.ORDER_NO AS RATEIO_OV
FROM IFSINFO.BS_F_TRANS_BANCARIAS_BASE A
left join ifsinfo.bs_f_agrup_titulo_forn E on a.ID_EMPRESA = E.COMPANY and A.N_TITULO = E.GROUP_ID 
left join ifsinfo.BS_F_RATEIO_OC d on d.company = A.ID_EMPRESA and coalesce(E.INVOICE_ID,IFSLAF.INVOICE_API.Get_Invoice_Id_Db(A.ID_EMPRESA, A.ID_PARCEIRO, 'SUPPLIER', A.ID_SERIE,A.N_TITULO)) = d.invoice_id
left join ifsinfo.bs_f_rateio_titu_forn b on b.company = A.ID_EMPRESA and coalesce(E.INVOICE_ID,IFSLAF.INVOICE_API.Get_Invoice_Id_Db(A.ID_EMPRESA, A.ID_PARCEIRO, 'SUPPLIER', A.ID_SERIE,A.N_TITULO)) = b.invoice_id
left join ifsinfo.BS_F_RATEIO_OV c on c.company = A.ID_EMPRESA and IFSLAF.INVOICE_API.Get_Invoice_Id_Db(A.ID_EMPRESA, A.ID_PARCEIRO, 'CUSTOMER', A.ID_SERIE, A.N_TITULO) = c.invoice_id
